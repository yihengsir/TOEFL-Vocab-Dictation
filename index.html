<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEFL 词汇测试 - 完整版</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for speaker icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles and utility classes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* 更柔和的背景色 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem; /* 增加整体内边距 */
            overflow-y: auto;
        }

        .main-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* 更大的圆角 */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); /* 更明显的阴影 */
            padding: 2.5rem 3rem; /* 增加内边距 */
            width: 100%;
            max-width: 800px; /* 适当增加最大宽度 */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* 增加模块间距 */
            text-align: center;
            position: relative; /* 用于返回按钮的定位 */
        }

        /* 所有视图共享的样式 */
        .view {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* 视图内部元素间距 */
            /* 调试 CSS: 确保视图在最上层且可交互 */
            position: relative; /* 确保 z-index 有效 */
            z-index: 10; /* 确保视图层级高于其他潜在遮盖物 */
            pointer-events: auto; /* 确保该元素及其子元素可交互 */
        }

        /* 标题样式 */
        .view-title {
            @apply text-3xl md:text-4xl font-extrabold text-gray-800 mb-6; /* 更深的颜色，更粗的字体 */
        }

        /* 主要按钮样式 */
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-xl transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 w-2/3 md:w-1/2 mx-auto;
            letter-spacing: 0.05em; /* 增加字母间距 */
            pointer-events: auto; /* 明确设置为可交互 */
            z-index: 20; /* 确保按钮层级高于其容器 */
        }

        /* 次要按钮/选择项样式 (卡片化) */
        .btn-selection-item {
            @apply bg-white border border-gray-200 text-gray-800 font-semibold py-4 px-6 rounded-xl shadow-md cursor-pointer transition duration-200 hover:bg-gray-50 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-400;
            text-align: center;
            min-height: 80px; /* 确保按钮有足够高度，内容不会太挤 */
            display: flex; /* 使用flex布局让内容垂直居中 */
            align-items: center;
            justify-content: center;
            pointer-events: auto; /* 明确设置为可交互 */
            z-index: 20; /* 确保按钮层级高于其容器 */
        }

        .btn-selection-item-selected {
            @apply bg-blue-500 text-white border-blue-500 shadow-xl ring-2 ring-blue-300;
        }
        .btn-selection-item-selected:hover {
             @apply bg-blue-600; /* 选中状态下 hover 颜色稍微变深 */
        }

        /* 返回按钮样式 */
        .btn-back {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full shadow-md transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-200 absolute top-6 left-6 z-10;
            pointer-events: auto; /* 明确设置为可交互 */
        }

        /* 隐藏类 */
        .hidden {
            display: none !important;
        }

        /* 不同的选择网格布局 */
        .grid-layout {
            @apply grid gap-4 w-full; /* 基础网格间距 */
            pointer-events: auto; /* 确保网格容器可交互 */
            z-index: 15; /* 确保网格容器层级高于其他潜在遮盖物 */
        }
        .grid-col-1-md-2 {
            @apply grid-cols-1 md:grid-cols-2;
        }
        .grid-col-2-md-3 {
            @apply grid-cols-2 md:grid-cols-3;
        }
        .grid-col-3-md-5 {
            @apply grid-cols-3 md:grid-cols-5;
        }

        /* 额外优化：输入框样式 */
        .input-field {
            @apply block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm text-lg text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200;
        }

        /* 听写测试特定样式 */
        .quiz-question-display {
            @apply bg-blue-100 text-blue-900 text-3xl font-bold py-6 px-4 rounded-lg shadow-inner;
        }
        .quiz-input-field {
            @apply border-2 border-gray-300 rounded-lg p-3 text-xl w-full text-center;
        }
        .feedback-correct {
            @apply bg-green-100 border-green-500 text-green-800;
        }
        .feedback-incorrect {
            @apply bg-red-100 border-red-500 text-red-800;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .play-button {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
            padding: 0;
            vertical-align: middle;
            transition: color 0.2s;
        }
        .play-button:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="app-container" class="main-container">
        <!-- 欢迎/角色选择视图 -->
        <div id="welcome-view" class="view">
            <h1 class="view-title">
                TOEFL 词汇练习
            </h1>
            <p class="text-xl text-gray-700 mb-8">请选择您的身份：</p>
            <button id="vip-student-btn" class="btn-primary">我是 VIP 学生</button>
            <button id="class-student-btn" class="btn-primary">我是班课学生</button>
        </div>

        <!-- 身份确认视图 -->
        <div id="confirm-role-view" class="view hidden">
            <button id="confirm-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                确认您的身份
            </h2>
            <p id="confirm-role-text" class="text-xl text-purple-700 font-semibold mb-8">
                您已选择：<span id="confirmed-role"></span>
            </p>
            <button id="confirm-role-continue-btn" class="btn-primary bg-purple-600 hover:bg-purple-700 focus:ring-purple-300">继续</button>
        </div>

        <!-- 词库选择视图 -->
        <div id="selection-view" class="view hidden">
            <button id="selection-back-btn" class="btn-back">返回</button>
            <h2 id="selection-title" class="view-title">
                请选择分类
            </h2>
            <div id="selection-content" class="grid-layout grid-col-1-md-2">
                <!-- 动态内容会填充在这里 -->
            </div>
        </div>

        <!-- 学生信息填写视图 -->
        <div id="info-view" class="view hidden">
            <button id="info-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                填写学生信息
            </h2>
            <input type="text" id="student-name-input" class="input-field mb-4" placeholder="请输入您的姓名" />
            <input type="text" id="student-class-input" class="input-field mb-6 hidden" placeholder="请输入您的班级 (班课学生)" />
            <button id="start-test-btn" class="btn-primary">开始测试</button>
        </div>

        <!-- 听写测试视图 -->
        <div id="test-view" class="view hidden">
            <button id="test-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                听写测试
            </h2>
            <div id="quiz-area" class="flex flex-col gap-6 w-full">
                <div id="question-display" class="quiz-question-display">
                    加载词汇...
                </div>

                <input type="text" id="answer-input" class="quiz-input-field" placeholder="在此输入英文词汇或短语..." autofocus>

                <div id="example-sentence-display" class="bg-gray-50 p-4 rounded-lg shadow-inner text-gray-700 text-sm italic min-h-[60px] flex items-center justify-center">
                    点击 "获取例句" 查看上下文
                </div>

                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button id="get-example-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
                        获取例句
                    </button>
                    <button id="check-answer-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        检查答案
                    </button>
                    <button id="next-word-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 hidden">
                        下一个
                    </button>
                </div>

                <div class="flex justify-center mt-4">
                    <button id="end-test-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                        结束测试
                    </button>
                </div>

                <div id="feedback-message" class="text-lg font-semibold min-h-[30px]"></div>
            </div>
        </div>

        <!-- 测试结果视图 -->
        <div id="results-view" class="view hidden">
            <button id="results-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                测试结果
            </h2>
            <div id="test-summary" class="text-left text-lg text-gray-800 mb-6">
                <p><strong>姓名:</strong> <span id="summary-name"></span></p>
                <p id="summary-class-row"><strong>班级:</strong> <span id="summary-class"></span></p>
                <p><strong>日期:</strong> <span id="summary-date"></span></p>
                <p><strong>正确率:</strong> <span id="summary-accuracy" class="font-bold"></span></p>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                答错题目列表 (<span id="incorrect-count">0</span> 题)
            </h3>
            <div id="results-list" class="text-left bg-gray-50 p-4 rounded-lg shadow-inner w-full max-h-96 overflow-y-auto"></div>
            <button id="results-restart-btn" class="btn-primary mt-8">重新开始练习</button>
        </div>
    </div>

    <script>
        // --- DOM 元素引用 ---
        const appContainer = document.getElementById('app-container');
        const welcomeView = document.getElementById('welcome-view');
        const confirmRoleView = document.getElementById('confirm-role-view');
        const selectionView = document.getElementById('selection-view');
        const infoView = document.getElementById('info-view');
        const testView = document.getElementById('test-view');
        const resultsView = document.getElementById('results-view');

        const vipStudentBtn = document.getElementById('vip-student-btn');
        const classStudentBtn = document.getElementById('class-student-btn');

        const confirmBackBtn = document.getElementById('confirm-back-btn');
        const confirmedRoleSpan = document.getElementById('confirmed-role');
        const confirmRoleContinueBtn = document.getElementById('confirm-role-continue-btn');

        const selectionBackBtn = document.getElementById('selection-back-btn');
        const selectionTitle = document.getElementById('selection-title');
        const selectionContent = document.getElementById('selection-content');

        const studentNameInput = document.getElementById('student-name-input');
        const studentClassInput = document.getElementById('student-class-input');
        const startTestBtn = document.getElementById('start-test-btn');
        const infoBackBtn = document.getElementById('info-back-btn');

        // Test View specific elements
        const questionDisplay = document.getElementById('question-display');
        const answerInput = document.getElementById('answer-input');
        const getExampleBtn = document.getElementById('get-example-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextWordBtn = document.getElementById('next-word-btn');
        const endTestBtn = document.getElementById('end-test-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const exampleSentenceDisplay = document.getElementById('example-sentence-display');
        const testBackBtn = document.getElementById('test-back-btn');

        // Results View specific elements
        const summaryName = document.getElementById('summary-name');
        const summaryClass = document.getElementById('summary-class');
        const summaryClassRow = document.getElementById('summary-class-row');
        const summaryDate = document.getElementById('summary-date');
        const summaryAccuracy = document.getElementById('summary-accuracy');
        const incorrectCountSpan = document.getElementById('incorrect-count');
        const resultsList = document.getElementById('results-list');
        const resultsRestartBtn = document.getElementById('results-restart-btn');
        const resultsBackBtn = document.getElementById('results-back-btn');


        // --- 全局应用状态 ---
        const appState = {
            currentView: 'welcome-view', // 当前显示的视图ID
            userRole: '', // 'vip' 或 'class'
            selectedCategory: '', // 'reading', 'listening', 'speaking', 'writing'
            selectedLevel: '',    // 'beginner', 'intermediate', 'advanced'
            selectedContentType: '',  // 'unit' 或 'past'
            selectedUnit: '',     // 'unit1' 到 'unit10'
            studentName: '',
            studentClass: '',
            viewHistory: [], // 用于追踪视图历史，方便返回
            currentTestVocabulary: [], // 存储当前测试的词汇数据
            shuffledTestVocabulary: [], // 当前测试打乱后的词汇顺序
            currentWordIndex: 0,
            correctAnswersCount: 0,
            questionsAttempted: 0,
            incorrectAnswers: [], // 存储答错的题目详情
            testStartTime: null, // 记录测试开始时间
        };

        // --- 词库结构映射（指向实际的JSON文件路径） ---
        const vocabStructure = {
            reading: {
                beginner: {
                    unit: ['reading_beginner_unit1.json', 'reading_beginner_unit2.json', 'reading_beginner_unit3.json', 'reading_beginner_unit4.json', 'reading_beginner_unit5.json', 'reading_beginner_unit6.json', 'reading_beginner_unit7.json', 'reading_beginner_unit8.json', 'reading_beginner_unit9.json', 'reading_beginner_unit10.json'],
                    past: 'expressions.json' // 将 expressions.json 映射到这里
                },
                intermediate: {
                    unit: ['reading_intermediate_unit1.json', 'reading_intermediate_unit2.json', 'reading_intermediate_unit3.json', 'reading_intermediate_unit4.json', 'reading_intermediate_unit5.json', 'reading_intermediate_unit6.json', 'reading_intermediate_unit7.json', 'reading_intermediate_unit8.json', 'reading_intermediate_unit9.json', 'reading_intermediate_unit10.json'],
                    past: 'reading_intermediate_past.json'
                },
                advanced: {
                    unit: ['reading_advanced_unit1.json', 'reading_advanced_unit2.json', 'reading_advanced_unit3.json', 'reading_advanced_unit4.json', 'reading_advanced_unit5.json', 'reading_advanced_unit6.json', 'reading_advanced_unit7.json', 'reading_advanced_unit8.json', 'reading_advanced_unit9.json', 'reading_advanced_unit10.json'],
                    past: 'reading_advanced_past.json'
                }
            },
            listening: {
                // 根据您上传的实际文件，将所有单元扩展到10个
                beginner: { unit: ['listening_beginner_unit1.json', 'listening_beginner_unit2.json', 'listening_beginner_unit3.json', 'listening_beginner_unit4.json', 'listening_beginner_unit5.json', 'listening_beginner_unit6.json', 'listening_beginner_unit7.json', 'listening_beginner_unit8.json', 'listening_beginner_unit9.json', 'listening_beginner_unit10.json'], past: 'listening_beginner_past.json' },
                intermediate: { unit: ['listening_intermediate_unit1.json', 'listening_intermediate_unit2.json', 'listening_intermediate_unit3.json', 'listening_intermediate_unit4.json', 'listening_intermediate_unit5.json', 'listening_intermediate_unit6.json', 'listening_intermediate_unit7.json', 'listening_intermediate_unit8.json', 'listening_intermediate_unit9.json', 'listening_intermediate_unit10.json'], past: 'listening_intermediate_past.json' },
                advanced: { unit: ['listening_advanced_unit1.json', 'listening_advanced_unit2.json', 'listening_advanced_unit3.json', 'listening_advanced_unit4.json', 'listening_advanced_unit5.json', 'listening_advanced_unit6.json', 'listening_advanced_unit7.json', 'listening_advanced_unit8.json', 'listening_advanced_unit9.json', 'listening_advanced_unit10.json'], past: 'listening_advanced_past.json' }
            },
            speaking: {
                // 根据您上传的实际文件，将所有单元扩展到10个
                beginner: { unit: ['speaking_beginner_unit1.json', 'speaking_beginner_unit2.json', 'speaking_beginner_unit3.json', 'speaking_beginner_unit4.json', 'speaking_beginner_unit5.json', 'speaking_beginner_unit6.json', 'speaking_beginner_unit7.json', 'speaking_beginner_unit8.json', 'speaking_beginner_unit9.json', 'speaking_beginner_unit10.json'], past: 'speaking_beginner_past.json' },
                intermediate: { unit: ['speaking_intermediate_unit1.json', 'speaking_intermediate_unit2.json', 'speaking_intermediate_unit3.json', 'speaking_intermediate_unit4.json', 'speaking_intermediate_unit5.json', 'speaking_intermediate_unit6.json', 'speaking_intermediate_unit7.json', 'speaking_intermediate_unit8.json', 'speaking_intermediate_unit9.json', 'speaking_intermediate_unit10.json'], past: 'speaking_intermediate_past.json' },
                advanced: { unit: ['speaking_advanced_unit1.json', 'speaking_advanced_unit2.json', 'speaking_advanced_unit3.json', 'speaking_advanced_unit4.json', 'speaking_advanced_unit5.json', 'speaking_advanced_unit6.json', 'speaking_advanced_unit7.json', 'speaking_advanced_unit8.json', 'speaking_advanced_unit9.json', 'speaking_advanced_unit10.json'], past: 'speaking_advanced_past.json' }
            },
            writing: {
                beginner: { unit: ['writing_beginner_unit1.json'], past: 'writing_beginner_past.json' },
                intermediate: { unit: ['writing_intermediate_unit1.json'], past: 'writing_intermediate_past.json' },
                advanced: { unit: ['writing_advanced_unit1.json'], past: 'writing_advanced_past.json' }
            }
        };

        // LLM API Key (留空，GitHub Pages 上部署需要您手动填入)
        const apiKey = "";
        let speechSynth = window.speechSynthesis;
        let voicesLoaded = false;


        // --- 核心视图管理函数 ---
        /**
         * 切换到指定视图，并更新视图历史。
         * @param {string} viewId - 要显示的视图的ID。
         * @param {boolean} [pushToHistory=true] - 是否将当前视图推入历史栈。
         */
        function showView(viewId, pushToHistory = true) {
            console.log(`[showView] Attempting to show view: ${viewId}. Current appState.currentView: ${appState.currentView}`);
            // 隐藏所有视图
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });

            // 显示目标视图
            document.getElementById(viewId).classList.remove('hidden');

            // 更新历史记录
            if (pushToHistory && appState.currentView !== viewId) { // 避免重复添加当前视图
                appState.viewHistory.push(appState.currentView);
                console.log(`[showView] Added ${appState.currentView} to history. History:`, appState.viewHistory);
            }
            appState.currentView = viewId;

            // 根据视图渲染内容
            renderViewContent(viewId);
            console.log(`[showView] Finished showing view: ${viewId}`);
        }

        /**
         * 渲染特定视图的内容。
         * @param {string} viewId - 当前视图的ID。
         */
        function renderViewContent(viewId) {
            console.log(`[renderViewContent] Rendering content for view: ${viewId}`);
            // 清除 selectionContent 的类，每次渲染时重新设置
            selectionContent.classList.remove('grid-col-1-md-2', 'grid-col-2-md-3', 'grid-col-3-md-5');

            switch (viewId) {
                case 'welcome-view':
                    appState.viewHistory = [];
                    resetTestState();
                    console.log('[renderViewContent] Resetting appState and history.');
                    break;
                case 'confirm-role-view':
                    confirmedRoleSpan.textContent = appState.userRole === 'vip' ? 'VIP 学生' : '班课学生';
                    console.log(`[renderViewContent] Confirmed role: ${appState.userRole}`);
                    break;
                case 'selection-view':
                    if (appState.selectedUnit || appState.selectedContentType === 'past') {
                        console.log('[renderViewContent] Selection view: Rendering content type selection (from unit/past).');
                        renderContentTypeSelection(appState.selectedCategory, appState.selectedLevel);
                        if (appState.selectedContentType === 'unit') {
                            console.log('[renderViewContent] Selection view: Rendering unit selection.');
                            renderUnitSelection(appState.selectedCategory, appState.selectedLevel);
                        }
                    } else if (appState.selectedLevel) {
                        console.log('[renderViewContent] Selection view: Rendering level selection.');
                        renderLevelSelection(appState.selectedCategory);
                    } else if (appState.selectedCategory) {
                        console.log('[renderViewContent] Selection view: Rendering category selection (from level).');
                        renderCategorySelection();
                    } else {
                        console.log('[renderViewContent] Selection view: Initial render, rendering category selection.');
                        renderCategorySelection();
                    }
                    break;
                case 'info-view':
                    studentNameInput.value = '';
                    if (appState.userRole === 'class') {
                        studentClassInput.classList.remove('hidden');
                        studentClassInput.value = '';
                    } else {
                        studentClassInput.classList.add('hidden');
                        studentClassInput.value = '';
                    }
                    studentNameInput.focus();
                    console.log('[renderViewContent] Info view: Ready for student info.');
                    break;
                case 'test-view':
                    console.log('[renderViewContent] Test view: Initializing test logic.');
                    initializeTestLogic();
                    break;
                case 'results-view':
                    console.log('[renderViewContent] Results view: Rendering final results.');
                    renderFinalResults();
                    break;
            }
        }

        /**
         * 返回上一个视图。
         */
        function goBack() {
            console.log(`[goBack] Current view: ${appState.currentView}, History:`, appState.viewHistory);
            if (appState.viewHistory.length > 0) {
                const prevViewId = appState.viewHistory.pop();
                console.log(`[goBack] Popped ${prevViewId} from history.`);

                // 根据当前视图，重置相关状态
                if (appState.currentView === 'selection-view') {
                    // When going back from a deeper selection level, clear the deeper state
                    if (appState.selectedUnit || appState.selectedContentType === 'past') {
                         appState.selectedUnit = '';
                         appState.selectedContentType = '';
                         console.log('[goBack] Resetting selectedUnit and selectedContentType.');
                    } else if (appState.selectedLevel) {
                        appState.selectedLevel = '';
                        console.log('[goBack] Resetting selectedLevel.');
                    } else if (appState.selectedCategory) {
                        appState.selectedCategory = '';
                        console.log('[goBack] Resetting selectedCategory.');
                    }
                } else if (appState.currentView === 'info-view') {
                    appState.studentName = '';
                    appState.studentClass = '';
                    console.log('[goBack] Resetting student info.');
                } else if (appState.currentView === 'confirm-role-view') {
                    appState.userRole = '';
                    console.log('[goBack] Resetting user role.');
                } else if (appState.currentView === 'test-view') {
                    resetTestState();
                    console.log('[goBack] Resetting test state from test view.');
                } else if (appState.currentView === 'results-view') {
                    resetTestState();
                    console.log('[goBack] Resetting test state from results view.');
                }

                showView(prevViewId, false); // 不推入历史，因为它已经被弹出了
                console.log(`[goBack] Navigated to previous view: ${prevViewId}`);
            } else {
                console.log('[goBack] History is empty, cannot go back.');
            }
        }


        // --- 渲染词库选择视图的不同阶段 ---
        /**
         * 渲染一级分类（Reading, Listening, Speaking, Writing）。
         */
        function renderCategorySelection() {
            console.log('[renderCategorySelection] Starting to render category selection buttons.');
            selectionTitle.textContent = '请选择分类';
            selectionContent.innerHTML = ''; // Clear previous content
            selectionContent.classList.add('grid-col-1-md-2');

            const categories = Object.keys(vocabStructure);
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('btn-selection-item'); // Apply base styles
                if (appState.selectedCategory === category) {
                    button.classList.add('btn-selection-item-selected'); // Mark as selected
                }
                button.textContent = categoryNames[category] + ' ( ' + capitalizeFirstLetter(category) + ' )';
                button.dataset.category = category;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Category button "${category}" clicked! Event target:`, event.target);
                    appState.selectedCategory = category;
                    appState.selectedLevel = '';
                    appState.selectedContentType = '';
                    appState.selectedUnit = '';
                    showView('selection-view'); // Re-render selection-view to next level
                });
                selectionContent.appendChild(button);
                console.log(`[renderCategorySelection] Appended button for ${category}.`);
            });
            console.log('[renderCategorySelection] Finished rendering category selection buttons.');
        }

        /**
         * 渲染二级分类（初级、中级、高级）。
         * @param {string} category - 已选择的一级分类。
         */
        function renderLevelSelection(category) {
            console.log(`[renderLevelSelection] Starting to render level selection buttons for category: ${category}.`);
            selectionTitle.textContent = `选择 ${categoryNames[category]} 难度`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-2-md-3');

            const levels = Object.keys(vocabStructure[category]);
            
            levels.forEach(level => {
                const button = document.createElement('button');
                button.classList.add('btn-selection-item');
                if (appState.selectedLevel === level) {
                    button.classList.add('btn-selection-item-selected');
                }
                button.textContent = levelNames[level] + ' ( ' + capitalizeFirstLetter(level) + ' )';
                button.dataset.level = level;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Level button "${level}" clicked! Event target:`, event.target);
                    appState.selectedLevel = level;
                    appState.selectedContentType = '';
                    appState.selectedUnit = '';
                    showView('selection-view'); // Re-render selection-view to next level
                });
                selectionContent.appendChild(button);
                console.log(`[renderLevelSelection] Appended button for level ${level}.`);
            });
            console.log('[renderLevelSelection] Finished rendering level selection buttons.');
        }

        /**
         * 渲染三级分类（按照授课单元、按照往期内容）。
         * @param {string} category - 已选择的一级分类。
         * @param {string} level - 已选择的二级分类。
         */
        function renderContentTypeSelection(category, level) {
            console.log(`[renderContentTypeSelection] Starting to render content type selection buttons for ${category}-${level}.`);
            selectionTitle.textContent = `选择 ${categoryNames[category]} ${levelNames[level]} 内容类型`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-1-md-2');

            const availableTypes = Object.keys(vocabStructure[category][level]);

            const contentTypes = ['unit', 'past'];
            const contentNames = {
                unit: '按照授课单元',
                past: '按照往期内容'
            };

            contentTypes.forEach(type => {
                if (availableTypes.includes(type)) {
                    const button = document.createElement('button');
                    button.classList.add('btn-selection-item');
                    if (appState.selectedContentType === type) {
                        button.classList.add('btn-selection-item-selected');
                    }
                    button.textContent = contentNames[type];
                    button.dataset.contentType = type;
                    button.addEventListener('click', (event) => {
                        console.log(`[Click] Content type button "${type}" clicked! Event target:`, event.target);
                        appState.selectedContentType = type;
                        appState.selectedUnit = '';
                        if (type === 'unit') {
                            showView('selection-view'); // Re-render selection-view to next level (unit selection)
                        } else { // 'past'
                            handleFinalSelection(); // Load vocabulary and proceed to info page
                        }
                    });
                    selectionContent.appendChild(button);
                    console.log(`[renderContentTypeSelection] Appended button for content type ${type}.`);
                }
            });
            console.log('[renderContentTypeSelection] Finished rendering content type selection buttons.');
        }

        /**
         * 渲染授课单元选择（根据 vocabStructure 实际配置的单元）。
         * @param {string} category - 已选择的一级分类。
         * @param {string} level - 已选择的二级分类。
         */
        function renderUnitSelection(category, level) {
            console.log(`[renderUnitSelection] Starting to render unit selection buttons for ${category}-${level}.`);
            selectionTitle.textContent = `选择 ${categoryNames[category]} ${levelNames[level]} 授课单元`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-3-md-5');

            const unitsAvailable = vocabStructure[category]?.[level]?.unit;
            if (!unitsAvailable || unitsAvailable.length === 0) {
                selectionContent.innerHTML = '<p class="text-gray-600">当前难度暂无单元词库。</p>';
                console.log('[renderUnitSelection] No units available for this selection.');
                return;
            }

            unitsAvailable.forEach(unitFileName => {
                const unitNumberMatch = unitFileName.match(/unit(\d+)\.json/);
                const unitNumber = unitNumberMatch ? unitNumberMatch[1] : unitFileName;

                const button = document.createElement('button');
                button.classList.add('btn-selection-item');
                 if (appState.selectedUnit === unitFileName) {
                    button.classList.add('btn-selection-item-selected');
                }
                button.textContent = `单元 ${unitNumber}`;
                button.dataset.unit = unitFileName;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Unit button "${unitFileName}" clicked! Event target:`, event.target);
                    appState.selectedUnit = unitFileName;
                    handleFinalSelection(); // Load vocabulary and proceed to info page
                });
                selectionContent.appendChild(button);
                console.log(`[renderUnitSelection] Appended button for unit ${unitNumber}.`);
            });
            console.log('[renderUnitSelection] Finished rendering unit selection buttons.');
        }

        /**
         * 处理最终选择并加载词汇数据。
         */
        async function handleFinalSelection() {
            console.log('[handleFinalSelection] Starting vocabulary loading...');
            let jsonFileName = '';
            if (appState.selectedContentType === 'unit') {
                jsonFileName = appState.selectedUnit;
            } else { // 'past'
                jsonFileName = vocabStructure[appState.selectedCategory][appState.selectedLevel].past;
            }
            const jsonPath = `data/${jsonFileName}`;
            console.log(`[handleFinalSelection] Attempting to load JSON from: ${jsonPath}`);

            selectionContent.innerHTML = '<p class="text-xl text-gray-600 animate-pulse">加载词汇中，请稍候...</p>';
            selectionContent.classList.remove('grid-col-1-md-2', 'grid-col-2-md-3', 'grid-col-3-md-5');
            selectionContent.classList.add('flex', 'justify-center', 'items-center', 'py-10');


            try {
                const response = await fetch(jsonPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${jsonPath}`);
                }
                appState.currentTestVocabulary = await response.json();

                if (!appState.currentTestVocabulary || appState.currentTestVocabulary.length === 0) {
                    console.warn('[handleFinalSelection] Loaded vocabulary is empty.');
                    alert('所选词库为空，请选择其他词库或联系老师添加词汇。');
                    goBack();
                    return;
                }

                console.log('[handleFinalSelection] Loaded vocabulary for test:', appState.currentTestVocabulary);
                showView('info-view'); // Proceed to student info view

            } catch (error) {
                console.error('[handleFinalSelection] Vocabulary loading error:', error);
                alert(`加载词库失败: ${error.message}。请检查以下文件是否存在且格式正确: ${jsonPath}。`);
                goBack();
            }
        }

        /**
         * 重置所有测试相关的状态数据。
         */
        function resetTestState() {
            console.log('[resetTestState] Resetting all test-related state.');
            appState.currentTestVocabulary = [];
            appState.shuffledTestVocabulary = [];
            appState.currentWordIndex = 0;
            appState.correctAnswersCount = 0;
            appState.questionsAttempted = 0;
            appState.incorrectAnswers = [];
            appState.testStartTime = null;
        }

        // --- 听写测试核心逻辑 (从旧版本复制并集成) ---
        function initializeTestLogic() {
            console.log('[initializeTestLogic] Initializing test logic...');
            appState.shuffledTestVocabulary = shuffleArray([...appState.currentTestVocabulary]);
            appState.currentWordIndex = 0;
            appState.correctAnswersCount = 0;
            appState.questionsAttempted = 0;
            appState.incorrectAnswers = [];
            appState.testStartTime = new Date();

            // 确保测试视图UI元素可见性正确
            answerInput.classList.remove('hidden');
            getExampleBtn.classList.remove('hidden');
            checkAnswerBtn.classList.remove('hidden');
            nextWordBtn.classList.add('hidden');
            endTestBtn.classList.remove('hidden');
            feedbackMessage.classList.remove('hidden');
            exampleSentenceDisplay.classList.remove('hidden');

            loadQuestion();
            console.log('[initializeTestLogic] Test initialized and first question loaded.');
        }

        function loadQuestion() {
            console.log(`[loadQuestion] Loading question ${appState.currentWordIndex + 1}...`);
            if (appState.currentWordIndex >= appState.shuffledTestVocabulary.length) {
                appState.shuffledTestVocabulary = shuffleArray([...appState.currentTestVocabulary]);
                appState.currentWordIndex = 0;
                console.log('[loadQuestion] Reached end of vocabulary, reshuffling and restarting.');
            }

            const currentPair = appState.shuffledTestVocabulary[appState.currentWordIndex];
            questionDisplay.textContent = currentPair.chinese;
            answerInput.value = '';
            answerInput.classList.remove('feedback-correct', 'feedback-incorrect');
            answerInput.readOnly = false;
            answerInput.focus();
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600');
            nextWordBtn.classList.add('hidden');
            checkAnswerBtn.classList.remove('hidden');
            exampleSentenceDisplay.textContent = '点击 "获取例句" 查看上下文';
            getExampleBtn.disabled = false;
            console.log(`[loadQuestion] Displaying Chinese: "${currentPair.chinese}"`);
        }

        function checkCurrentAnswer() {
            console.log('[checkCurrentAnswer] Checking answer...');
            appState.questionsAttempted++;
            const typedAnswer = answerInput.value.trim();
            const correctEnglish = appState.shuffledTestVocabulary[appState.currentWordIndex].english.trim();

            answerInput.readOnly = true;
            getExampleBtn.disabled = true;

            if (typedAnswer.toLowerCase() === correctEnglish.toLowerCase()) {
                feedbackMessage.textContent = '正确！👍';
                feedbackMessage.classList.remove('text-red-600');
                feedbackMessage.classList.add('text-green-600');
                answerInput.classList.add('feedback-correct');
                appState.correctAnswersCount++;
                playPronunciation(correctEnglish);
                console.log('[checkCurrentAnswer] Answer correct.');
            } else {
                feedbackMessage.innerHTML = `错误！正确答案是: "${correctEnglish}"`;
                feedbackMessage.appendChild(createPlayButton(correctEnglish));
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-600');
                answerInput.classList.add('feedback-incorrect');
                appState.incorrectAnswers.push({
                    chinese: appState.shuffledTestVocabulary[appState.currentWordIndex].chinese,
                    typed: typedAnswer,
                    correct: correctEnglish
                });
                console.log(`[checkCurrentAnswer] Answer incorrect. Correct: "${correctEnglish}", Typed: "${typedAnswer}"`);
            }

            checkAnswerBtn.classList.add('hidden');
            nextWordBtn.classList.remove('hidden');
            console.log('[checkCurrentAnswer] Answer checked. Ready for next word.');
        }

        function nextWord() {
            console.log('[nextWord] Moving to next word...');
            appState.currentWordIndex++;
            loadQuestion();
        }

        function endTestSession() {
            console.log('[endTestSession] Ending test session.');
            showView('results-view');
        }

        function renderFinalResults() {
            console.log('[renderFinalResults] Rendering final results...');
            // 隐藏测试视图中的所有可交互元素
            answerInput.classList.add('hidden');
            getExampleBtn.classList.add('hidden');
            checkAnswerBtn.classList.add('hidden');
            nextWordBtn.classList.add('hidden');
            endTestBtn.classList.add('hidden');
            feedbackMessage.classList.add('hidden');
            exampleSentenceDisplay.classList.add('hidden');


            // 填充结果总结
            summaryName.textContent = appState.studentName || '未填写';
            if (appState.userRole === 'class') {
                summaryClassRow.classList.remove('hidden');
                summaryClass.textContent = appState.studentClass || '未填写';
            } else {
                summaryClassRow.classList.add('hidden');
            }
            summaryDate.textContent = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let accuracy = 0;
            if (appState.questionsAttempted > 0) {
                accuracy = (appState.correctAnswersCount / appState.questionsAttempted) * 100;
            }
            summaryAccuracy.textContent = `${accuracy.toFixed(2)}% (${appState.correctAnswersCount} / ${appState.questionsAttempted})`;
            
            incorrectCountSpan.textContent = appState.incorrectAnswers.length;

            // 填充答错题目列表
            resultsList.innerHTML = '';
            if (appState.incorrectAnswers.length === 0) {
                resultsList.innerHTML = '<p class="text-green-700 font-semibold">太棒了！所有题目都正确！</p>';
                console.log('[renderFinalResults] All answers correct!');
            } else {
                appState.incorrectAnswers.forEach(item => {
                    const li = document.createElement('li');
                    li.classList.add('mb-2', 'pb-2', 'border-b', 'border-gray-200', 'flex', 'flex-col');
                    li.innerHTML = `
                        <p><strong>中文:</strong> ${item.chinese}</p>
                        <p class="flex items-center"><strong>您输入:</strong> <span class="text-red-600">${item.typed || '[未输入]'}</span></p>
                        <p class="flex items-center"><strong>正确答案:</strong> <span class="text-green-600">${item.correct}</span></p>
                    `;
                    const correctSpan = li.querySelector('.text-green-600');
                    if (correctSpan) {
                        correctSpan.parentNode.appendChild(createPlayButton(item.correct));
                    }
                    resultsList.appendChild(li);
                });
                console.log(`[renderFinalResults] Displaying ${appState.incorrectAnswers.length} incorrect answers.`);
            }
            console.log('[renderFinalResults] Results rendering complete.');
        }

        // --- 语音合成和LLM例句功能 ---

        /**
         * Plays the pronunciation of a given word.
         * @param {string} word - The word to pronounce.
         */
        function playPronunciation(word) {
            console.log(`[playPronunciation] Attempting to play: "${word}"`);
            if (!speechSynth || !voicesLoaded) {
                console.warn('SpeechSynthesis API not ready or supported in this browser. Pronunciation will not work.');
                return;
            }
            if (speechSynth.speaking) {
                speechSynth.cancel();
                console.log('[playPronunciation] Cancelling previous speech.');
            }
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            utterance.volume = 1;
            utterance.rate = 1;
            utterance.pitch = 1;
            speechSynth.speak(utterance);
            console.log(`[playPronunciation] Spoke: "${word}"`);
        }

        /**
         * Creates and returns a play button element.
         * @param {string} wordToSpeak - The word to be spoken when the button is clicked.
         * @returns {HTMLButtonElement} The play button element.
         */
        function createPlayButton(wordToSpeak) {
            const button = document.createElement('button');
            button.classList.add('play-button');
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            button.title = `播放 "${wordToSpeak}" 的发音`;
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                playPronunciation(wordToSpeak);
            });
            return button;
        }

        /**
         * Generates an example sentence using the Gemini API (gemini-2.0-flash).
         */
        async function getExampleSentence() {
            console.log('[getExampleSentence] Attempting to get example sentence...');
            const currentPair = appState.shuffledTestVocabulary[appState.currentWordIndex];
            const englishWord = currentPair.english;

            const isAnswerEmpty = answerInput.value.trim() === '';
            const isAnswerChecked = answerInput.readOnly;
            const isAnswerCorrect = answerInput.classList.contains('feedback-correct');

            if (isAnswerEmpty && !isAnswerChecked) {
                exampleSentenceDisplay.textContent = '请输入英文词汇或短语后再获取例句。';
                console.warn('[getExampleSentence] Answer input is empty, cannot get example.');
                return;
            } else if (isAnswerChecked && !isAnswerCorrect) {
                 exampleSentenceDisplay.textContent = '请检查您的答案（红色部分），并查看正确答案，再获取例句。';
                 console.warn('[getExampleSentence] Answer incorrect and checked, guiding user to correct first.');
                 return;
            }

            exampleSentenceDisplay.innerHTML = '<div class="loading-spinner"></div>';
            getExampleBtn.disabled = true;
            console.log(`[getExampleSentence] Prompting LLM for example of: "${englishWord}"`);

            try {
                const prompt = `请提供一个关于英文词汇或短语 "${englishWord}" 的例句。例句需适合中级英语学习者，且句子内容避免过于简单或过于复杂。`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    exampleSentenceDisplay.textContent = `例句: "${text}"`;
                    console.log(`[getExampleSentence] LLM example received: "${text}"`);
                } else {
                    exampleSentenceDisplay.textContent = '无法生成例句。请稍后再试。';
                    console.error('[getExampleSentence] LLM response structure unexpected:', result);
                }
            } catch (error) {
                exampleSentenceDisplay.textContent = '获取例句失败。请检查网络或稍后再试。';
                console.error('[getExampleSentence] Error calling LLM API:', error);
            } finally {
                if (!answerInput.readOnly) {
                    getExampleBtn.disabled = false;
                }
                console.log('[getExampleSentence] Example sentence request finished.');
            }
        }


        // --- 辅助映射对象（方便显示） ---
        const categoryNames = {
            reading: '阅读', listening: '听力', speaking: '口语', writing: '写作'
        };
        const levelNames = {
            beginner: '初级', intermediate: '中级', advanced: '高级'
        };
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // --- 语音合成初始化 ---
        if (speechSynth) {
            speechSynth.onvoiceschanged = () => {
                voicesLoaded = true;
                console.log('[SpeechSynthesis] Voices loaded.');
            };
            if (speechSynth.getVoices().length > 0) {
                voicesLoaded = true;
                console.log('[SpeechSynthesis] Voices already available.');
            }
        } else {
            console.warn('[SpeechSynthesis] 浏览器不支持 SpeechSynthesis API。发音功能将不可用。');
        }

        /**
         * Utility function to shuffle an array.
         * @param {Array} array
         * @returns {Array}
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 事件监听器 ---
        vipStudentBtn.addEventListener('click', () => {
            console.log('[Event] VIP Student button clicked.');
            appState.userRole = 'vip';
            showView('confirm-role-view');
        });

        classStudentBtn.addEventListener('click', () => {
            console.log('[Event] Class Student button clicked.');
            appState.userRole = 'class';
            showView('confirm-role-view');
        });

        confirmBackBtn.addEventListener('click', goBack);

        confirmRoleContinueBtn.addEventListener('click', () => {
            console.log('[Event] Confirm Role Continue button clicked.');
            appState.viewHistory = []; // From confirm-role-view, always start a fresh history for selection
            showView('selection-view');
        });

        selectionBackBtn.addEventListener('click', goBack);

        // 学生信息填写页面的开始测试按钮
        startTestBtn.addEventListener('click', () => {
            console.log('[Event] Start Test button clicked.');
            appState.studentName = studentNameInput.value.trim();
            if (appState.userRole === 'class') {
                appState.studentClass = studentClassInput.value.trim();
            } else {
                appState.studentClass = ''; // VIP students don't have a class
            }

            if (!appState.studentName) {
                alert('请输入您的姓名才能开始测试！');
                console.warn('[Event] Student name not entered.');
                return;
            }
            showView('test-view'); // 跳转到测试视图
        });
        infoBackBtn.addEventListener('click', goBack);

        // 听写测试视图的按钮
        checkAnswerBtn.addEventListener('click', checkCurrentAnswer);
        nextWordBtn.addEventListener('click', nextWord);
        endTestBtn.addEventListener('click', endTestSession); // 调用结束测试会话的函数
        getExampleBtn.addEventListener('click', getExampleSentence);
        testBackBtn.addEventListener('click', goBack); // 测试视图的返回按钮

        // 结果视图的重新开始按钮
        resultsRestartBtn.addEventListener('click', () => {
            console.log('[Event] Restart Test button clicked.');
            // 清除所有选择，回到欢迎界面，重新开始整个流程
            appState.userRole = '';
            appState.selectedCategory = '';
            appState.selectedLevel = '';
            appState.selectedContentType = '';
            appState.selectedUnit = '';
            appState.studentName = '';
            appState.studentClass = '';
            resetTestState(); // 彻底重置测试相关状态
            showView('welcome-view');
        });
        resultsBackBtn.addEventListener('click', goBack); // 结果视图的返回按钮


        // 允许按 Enter 键触发检查答案或下一个
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                console.log('[Event] Enter key pressed on answer input.');
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkCurrentAnswer();
                } else if (!nextWordBtn.classList.contains('hidden')) {
                    nextWord();
                }
            }
        });


        // --- 启动应用 ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[App Startup] DOMContentLoaded fired. Initializing view.');
            showView('welcome-view', false); // 默认显示欢迎视图，不推入历史
        });
    </script>
</body>
</html>
