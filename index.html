<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEFL 词汇测试 - 完整版</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for speaker icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for background and font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem; /* Increase overall padding */
            overflow-y: auto;
        }

        .main-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Larger rounded corners */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); /* More pronounced shadow */
            padding: 2.5rem 3rem; /* Increased padding */
            width: 100%;
            max-width: 800px; /* Adjusted max width */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Increased spacing between modules */
            text-align: center;
            position: relative; /* For absolute positioning of back button */
            pointer-events: auto !important; /* Ensure click events are passed */
            z-index: 1; /* Ensure it's above default layer and receives events */
        }

        /* Styles for all views */
        .view {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* Spacing between elements inside a view */
            position: relative; /* Ensure z-index works */
            z-index: 2; /* Ensure view is above main-container */
            pointer-events: auto; /* Ensure this element and its children are interactive */
        }

        /* Title styles */
        .view-title {
            font-size: 2.25rem; /* text-3xl */
            line-height: 2.5rem; /* leading-9 */
            font-weight: 800; /* font-extrabold */
            color: #1f2937; /* text-gray-800 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        /* Responsive adjustments for title */
        @media (min-width: 768px) {
            .view-title {
                font-size: 2.5rem; /* md:text-4xl */
                line-height: 1; /* md:leading-10 */
            }
        }

        /* Primary button styles */
        .btn-primary {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
            font-weight: 700; /* font-bold */
            padding: 0.75rem 2rem; /* py-3 px-8 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            transition-property: all;
            transition-duration: 300ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* transition-all */
            transform: scale(1); /* hover:scale-105 base */
            width: 66.666667%; /* w-2/3 */
            margin-left: auto;
            margin-right: auto;
            letter-spacing: 0.05em; /* Increase letter spacing */
            pointer-events: auto; /* Explicitly set to interactive */
            z-index: 3; /* Ensure button layer is above its container */
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
            transform: scale(1.05); /* hover:scale-105 */
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); /* focus:ring-4 focus:ring-blue-300 */
        }
        @media (min-width: 768px) {
            .btn-primary {
                width: 50%; /* md:w-1/2 */
            }
        }

        /* Secondary button/selection item styles (card-like) */
        .btn-selection-item {
            background-color: #ffffff; /* bg-white */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            color: #1f2937; /* text-gray-800 */
            font-weight: 600; /* font-semibold */
            padding: 1rem 1.5rem; /* py-4 px-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            cursor: pointer;
            transition-property: all;
            transition-duration: 200ms; /* transition-all */
            text-align: center;
            min-height: 80px; /* Ensure sufficient height */
            display: flex; /* Use flexbox for vertical centering */
            align-items: center;
            justify-content: center;
            pointer-events: auto; /* Explicitly set to interactive */
            z-index: 3; /* Ensure button layer is above its container */
        }
        .btn-selection-item:hover {
            background-color: #f9fafb; /* hover:bg-gray-50 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-lg */
        }
        .btn-selection-item:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5); /* focus:ring-2 focus:ring-blue-400 */
        }

        .btn-selection-item-selected {
            background-color: #3b82f6; /* bg-blue-500 */
            color: #ffffff; /* text-white */
            border-color: #3b82f6; /* border-blue-500 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* ring-2 ring-blue-300 */
        }
        .btn-selection-item-selected:hover {
             background-color: #2563eb; /* bg-blue-600 */
        }

        /* Back button styles */
        .btn-back {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
            font-weight: 700; /* font-bold */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            transition-property: all;
            transition-duration: 300ms;
            transform: scale(1); /* hover:scale-105 base */
            position: absolute;
            top: 1.5rem; /* top-6 */
            left: 1.5rem; /* left-6 */
            z-index: 10;
            pointer-events: auto; /* Explicitly set to interactive */
        }
        .btn-back:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
            transform: scale(1.05); /* hover:scale-105 */
        }
        .btn-back:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(209, 213, 219, 0.5); /* focus:ring-4 focus:ring-gray-200 */
        }

        /* Hidden utility class */
        .hidden {
            display: none !important;
        }

        /* Different selection grid layouts */
        .grid-layout {
            display: grid;
            gap: 1rem; /* gap-4 */
            width: 100%; /* w-full */
            pointer-events: auto; /* Ensure grid container is interactive */
            z-index: 2; /* Ensure grid container is above view */
        }
        .grid-col-1-md-2 {
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* grid-cols-1 */
        }
        @media (min-width: 768px) {
            .grid-col-1-md-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* md:grid-cols-2 */
            }
        }

        .grid-col-2-md-3 {
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* grid-cols-2 */
        }
        @media (min-width: 768px) {
            .grid-col-2-md-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* md:grid-cols-3 */
            }
        }

        .grid-col-3-md-5 {
            grid-template-columns: repeat(3, minmax(0, 1fr)); /* grid-cols-3 */
        }
        @media (min-width: 768px) {
            .grid-col-3-md-5 {
                grid-template-columns: repeat(5, minmax(0, 1fr)); /* md:grid-cols-5 */
            }
        }

        /* Input field generic styles */
        .input-field {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem; /* px-4 py-3 */
            border: 1px solid #d1d5db; /* border border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 1.125rem; /* text-lg */
            color: #1f2937; /* text-gray-800 */
            background-color: #ffffff; /* bg-white */
            transition-property: all;
            transition-duration: 200ms;
        }
        .input-field::placeholder {
            color: #9ca3af; /* placeholder-gray-400 */
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* focus:ring-2 focus:ring-blue-500 */
        }


        /* Dictation test specific styles */
        .quiz-question-display {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-900 */
            font-size: 3rem; /* text-4xl */
            line-height: 1.3; /* Adjusted line-height */
            font-weight: 800; /* font-extrabold */
            padding: 2rem 1.5rem; /* py-8 px-6 */
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            min-height: 120px; /* Ensure sufficient height */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 768px) {
            .quiz-question-display {
                font-size: 3.75rem; /* md:text-5xl */
            }
        }

        .quiz-input-field {
            border: 2px solid #d1d5db; /* border-2 border-gray-300 */
            background-color: #ffffff; /* bg-white */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            font-size: 1.25rem; /* text-xl */
            color: #1f2937; /* text-gray-800 */
            width: 100%; /* w-full */
            text-align: center;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* shadow-inner */
            transition-property: all;
            transition-duration: 200ms;
        }
        .quiz-input-field:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5); /* focus:ring-2 focus:ring-blue-200 */
        }

        .feedback-correct {
            background-color: #d1fae5; /* bg-green-100 */
            border-color: #22c55e; /* border-green-500 */
            color: #166534; /* text-green-800 */
        }
        .feedback-incorrect {
            background-color: #fee2e2; /* bg-red-100 */
            border-color: #ef4444; /* border-red-500 */
            color: #991b1b; /* text-red-800 */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .play-button {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
            padding: 0;
            vertical-align: middle;
            transition: color 0.2s;
        }
        .play-button:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="app-container" class="main-container">
        <!-- Welcome/Role Selection View -->
        <div id="welcome-view" class="view">
            <h1 class="view-title">
                TOEFL 词汇练习
            </h1>
            <p class="text-xl text-gray-700 mb-8">请选择您的身份：</p>
            <button id="vip-student-btn" class="btn-primary">我是 VIP 学生</button>
            <button id="class-student-btn" class="btn-primary">我是班课学生</button>
        </div>

        <!-- Role Confirmation View -->
        <div id="confirm-role-view" class="view hidden">
            <button id="confirm-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                确认您的身份
            </h2>
            <p id="confirm-role-text" class="text-xl text-purple-700 font-semibold mb-8">
                您已选择：<span id="confirmed-role"></span>
            </p>
            <button id="confirm-role-continue-btn" class="btn-primary bg-purple-600 hover:bg-purple-700 focus:ring-purple-300">继续</button>
        </div>

        <!-- Vocabulary Selection View -->
        <div id="selection-view" class="view hidden">
            <button id="selection-back-btn" class="btn-back">返回</button>
            <h2 id="selection-title" class="view-title">
                请选择分类
            </h2>
            <div id="selection-content" class="grid-layout grid-col-1-md-2">
                <!-- Dynamic content will be populated here -->
            </div>
        </div>

        <!-- Student Information Input View -->
        <div id="info-view" class="view hidden">
            <button id="info-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                填写学生信息
            </h2>
            <input type="text" id="student-name-input" class="input-field mb-4" placeholder="请输入您的姓名" />
            <input type="text" id="student-class-input" class="input-field mb-6 hidden" placeholder="请输入您的班级 (班课学生)" />
            <button id="start-test-btn" class="btn-primary">开始测试</button>
        </div>

        <!-- Dictation Test View -->
        <div id="test-view" class="view hidden">
            <button id="test-back-btn" class="btn-back">返回</button>
            <!-- Top title, consistent with image -->
            <h2 class="view-title">TOEFL 词汇听写测试 (from锋锋老师)</h2>
            <div class="flex flex-col gap-6 w-full">
                <div id="question-display" class="quiz-question-display">
                    加载词汇...
                </div>

                <input type="text" id="answer-input" class="quiz-input-field" placeholder="在此输入英文词汇或短语..." autofocus>

                <div id="example-sentence-display" class="bg-gray-50 p-4 rounded-lg shadow-inner text-gray-700 text-sm italic min-h-[60px] flex items-center justify-center">
                    点击 "获取例句" 查看上下文
                </div>

                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button id="get-example-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
                        获取例句
                    </button>
                    <button id="check-answer-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        检查答案
                    </button>
                    <button id="next-word-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 hidden">
                        下一个
                    </button>
                </div>

                <div class="flex justify-center mt-4">
                    <button id="end-test-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                        结束测试
                    </button>
                </div>

                <div id="feedback-message" class="text-lg font-semibold min-h-[30px]"></div>
            </div>
        </div>

        <!-- Test Results View -->
        <div id="results-view" class="view hidden">
            <button id="results-back-btn" class="btn-back">返回</button>
            <h2 class="view-title">
                测试结果
            </h2>
            <div id="test-summary" class="text-left text-lg text-gray-800 mb-6">
                <p><strong>姓名:</strong> <span id="summary-name"></span></p>
                <p id="summary-class-row"><strong>班级:</strong> <span id="summary-class"></span></p>
                <p><strong>日期:</strong> <span id="summary-date"></span></p>
                <p><strong>正确率:</strong> <span id="summary-accuracy" class="font-bold"></span></p>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                答错题目列表 (<span id="incorrect-count">0</span> 题)
            </h3>
            <div id="results-list" class="text-left bg-gray-50 p-4 rounded-lg shadow-inner w-full max-h-96 overflow-y-auto"></div>
            <button id="results-restart-btn" class="btn-primary mt-8">重新开始练习</button>
        </div>
    </div>

    <script type="module">
        // Firebase module imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM element references ---
        const appContainer = document.getElementById('app-container');
        const welcomeView = document.getElementById('welcome-view');
        const confirmRoleView = document.getElementById('confirm-role-view');
        const selectionView = document.getElementById('selection-view');
        const infoView = document.getElementById('info-view');
        const testView = document.getElementById('test-view');
        const resultsView = document.getElementById('results-view');

        const vipStudentBtn = document.getElementById('vip-student-btn');
        const classStudentBtn = document.getElementById('class-student-btn');

        const confirmBackBtn = document.getElementById('confirm-back-btn');
        const confirmedRoleSpan = document.getElementById('confirmed-role');
        const confirmRoleContinueBtn = document.getElementById('confirm-role-continue-btn');

        const selectionBackBtn = document.getElementById('selection-back-btn');
        const selectionTitle = document.getElementById('selection-title');
        const selectionContent = document.getElementById('selection-content');

        const studentNameInput = document.getElementById('student-name-input');
        const studentClassInput = document.getElementById('student-class-input');
        const startTestBtn = document.getElementById('start-test-btn');
        const infoBackBtn = document.getElementById('info-back-btn');

        // Test View specific elements
        const questionDisplay = document.getElementById('question-display');
        const answerInput = document.getElementById('answer-input');
        const getExampleBtn = document.getElementById('get-example-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextWordBtn = document.getElementById('next-word-btn');
        const endTestBtn = document.getElementById('end-test-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const exampleSentenceDisplay = document.getElementById('example-sentence-display');
        const testBackBtn = document.getElementById('test-back-btn');

        // Results View specific elements
        const summaryName = document.getElementById('summary-name');
        const summaryClass = document.getElementById('summary-class');
        const summaryClassRow = document.getElementById('summary-class-row');
        const summaryDate = document.getElementById('summary-date');
        const summaryAccuracy = document.getElementById('summary-accuracy');
        const incorrectCountSpan = document.getElementById('incorrect-count');
        const resultsList = document.getElementById('results-list');
        const resultsRestartBtn = document.getElementById('results-restart-btn');
        const resultsBackBtn = document.getElementById('results-back-btn');


        // --- Global Application State ---
        const appState = {
            currentView: 'welcome-view', // ID of the currently displayed view
            userRole: '', // 'vip' or 'class'
            selectedCategory: '', // 'reading', 'listening', 'speaking', 'writing'
            selectedLevel: '',    // 'beginner', 'intermediate', 'advanced'
            selectedContentType: '',  // 'unit' or 'past'
            selectedUnit: '',     // e.g., 'unit1' to 'unit10'
            studentName: '',
            studentClass: '',
            viewHistory: [], // Stack to track view history for back navigation
            currentTestVocabulary: [], // Stores the vocabulary data for the current test
            shuffledTestVocabulary: [], // Shuffled list of words for the current test session
            currentWordIndex: 0,
            correctAnswersCount: 0,
            questionsAttempted: 0,
            incorrectAnswers: [], // Stores details of incorrectly answered questions
            testStartTime: null, // Records the start time of the test
            userId: null, // Firebase Auth UID for the current user
        };

        // --- Firebase Initialization ---
        let db;
        let auth;
        let authReady = false; // Flag to indicate Firebase Auth is ready

        // Global variables provided by Canvas (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appState.userId = user.uid;
                    console.log("[Firebase] User is signed in:", user.uid);
                } else {
                    appState.userId = null;
                    console.log("[Firebase] No user is signed in. Attempting anonymous sign-in...");
                    try {
                        // If no initial auth token, sign in anonymously
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                            console.log("[Firebase] Signed in anonymously.");
                        }
                    } catch (error) {
                        console.error("[Firebase] Anonymous sign-in failed:", error);
                    }
                }
                authReady = true; // Mark auth as ready after initial check
                console.log("[Firebase] Auth state changed. authReady:", authReady);
            });

            // Sign in with custom token if available, otherwise anonymously
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("[Firebase] Signed in with custom token.");
                    } else {
                        // onAuthStateChanged will handle anonymous sign-in if no token
                        console.log("[Firebase] No custom token provided. Waiting for onAuthStateChanged to handle auth.");
                    }
                } catch (error) {
                    console.error("[Firebase] Initial auth failed:", error);
                    // Fallback to anonymous sign-in if custom token fails (onAuthStateChanged handles this)
                }
            })();

        } else {
            console.error("[Firebase] Firebase config is missing. Firestore features will not work.");
        }


        // --- Vocabulary Structure Mapping (points to actual JSON file paths) ---
        const vocabStructure = {
            reading: {
                beginner: {
                    unit: Array.from({length: 10}, (_, i) => `reading_beginner_unit${i + 1}.json`),
                    past: 'expressions.json' // VIP student test
                },
                intermediate: {
                    unit: Array.from({length: 10}, (_, i) => `reading_intermediate_unit${i + 1}.json`),
                    past: null // No past content file here
                },
                advanced: {
                    unit: Array.from({length: 10}, (_, i) => `reading_advanced_unit${i + 1}.json`),
                    past: null // No past content file here
                }
            },
            listening: {
                beginner: { unit: Array.from({length: 10}, (_, i) => `listening_beginner_unit${i + 1}.json`), past: null },
                intermediate: { unit: Array.from({length: 10}, (_, i) => `listening_intermediate_unit${i + 1}.json`), past: null },
                advanced: { unit: Array.from({length: 10}, (_, i) => `listening_advanced_unit${i + 1}.json`), past: null }
            },
            speaking: {
                beginner: { unit: Array.from({length: 10}, (_, i) => `speaking_beginner_unit${i + 1}.json`), past: null },
                intermediate: { unit: Array.from({length: 10}, (_, i) => `speaking_intermediate_unit${i + 1}.json`), past: null },
                advanced: { unit: Array.from({length: 10}, (_, i) => `speaking_advanced_unit${i + 1}.json`), past: null }
            },
            writing: {
                beginner: { unit: Array.from({length: 1}, (_, i) => `writing_beginner_unit${i + 1}.json`), past: null }, // Assuming only one unit
                intermediate: { unit: Array.from({length: 1}, (_, i) => `writing_intermediate_unit${i + 1}.json`), past: null }, // Assuming only one unit
                advanced: { unit: Array.from({length: 1}, (_, i) => `writing_advanced_unit${i + 1}.json`), past: null } // Assuming only one unit
            }
        };

        // LLM API Key (leave empty, Canvas runtime will automatically populate)
        const geminiApiKey = ""; // This will be automatically populated by Canvas runtime

        let speechSynth = window.speechSynthesis;
        let voicesLoaded = false;


        // --- Core View Management Functions ---
        /**
         * Switches to the specified view and updates view history.
         * @param {string} viewId - The ID of the view to display.
         * @param {boolean} [pushToHistory=true] - Whether to push the current view to the history stack.
         */
        function showView(viewId, pushToHistory = true) {
            console.log(`[showView] Attempting to show view: ${viewId}. Current appState.currentView: ${appState.currentView}`);
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });

            // Show the target view
            document.getElementById(viewId).classList.remove('hidden');

            // Update history
            if (pushToHistory && appState.currentView !== viewId) { // Avoid adding current view repeatedly
                appState.viewHistory.push(appState.currentView);
                console.log(`[showView] Added ${appState.currentView} to history. History:`, appState.viewHistory);
            }
            appState.currentView = viewId;

            // Render content based on the view
            renderViewContent(viewId);
            console.log(`[showView] Finished showing view: ${viewId}`);
        }

        /**
         * Renders the content of a specific view.
         * @param {string} viewId - The ID of the current view.
         */
        function renderViewContent(viewId) {
            console.log(`[renderViewContent] Rendering content for view: ${viewId}`);
            // Clear classes from selectionContent, reset on each render
            selectionContent.classList.remove('grid-col-1-md-2', 'grid-col-2-md-3', 'grid-col-3-md-5');

            switch (viewId) {
                case 'welcome-view':
                    appState.viewHistory = [];
                    resetTestState();
                    console.log('[renderViewContent] Resetting appState and history.');
                    break;
                case 'confirm-role-view':
                    confirmedRoleSpan.textContent = appState.userRole === 'vip' ? 'VIP 学生' : '班课学生';
                    console.log(`[renderViewContent] Confirmed role: ${appState.userRole}`);
                    break;
                case 'selection-view':
                    // Logic to determine which selection stage to render (category, level, content type, unit)
                    if (appState.selectedCategory && appState.selectedLevel && appState.selectedContentType === 'unit') {
                        // If category, level, and content type (unit) are selected, render unit selection
                        console.log('[renderViewContent] Selection view: Rendering unit selection.');
                        renderUnitSelection(appState.selectedCategory, appState.selectedLevel);
                    } else if (appState.selectedCategory && appState.selectedLevel) {
                        // If category and level are selected, but content type is not, render content type selection
                        console.log('[renderViewContent] Selection view: Rendering content type selection.');
                        renderContentTypeSelection(appState.selectedCategory, appState.selectedLevel);
                    } else if (appState.selectedCategory) {
                        // If only category is selected, render level selection
                        console.log('[renderViewContent] Selection view: Rendering level selection.');
                        renderLevelSelection(appState.selectedCategory);
                    } else {
                        // Otherwise (initial entry to selection view or returning from further back), render category selection
                        console.log('[renderViewContent] Selection view: Initial render, rendering category selection.');
                        renderCategorySelection();
                    }
                    break;
                case 'info-view':
                    studentNameInput.value = '';
                    if (appState.userRole === 'class') {
                        studentClassInput.classList.remove('hidden');
                        studentClassInput.value = '';
                    } else {
                        studentClassInput.classList.add('hidden');
                        studentClassInput.value = '';
                    }
                    studentNameInput.focus();
                    console.log('[renderViewContent] Info view: Ready for student info.');
                    break;
                case 'test-view':
                    console.log('[renderViewContent] Test view: Initializing test logic.');
                    initializeTestLogic();
                    break;
                case 'results-view':
                    console.log('[renderViewContent] Results view: Rendering final results.');
                    renderFinalResults();
                    break;
            }
        }

        /**
         * Navigates back to the previous view in history.
         */
        function goBack() {
            console.log(`[goBack] Current view: ${appState.currentView}, History:`, appState.viewHistory);
            if (appState.viewHistory.length > 0) {
                const prevViewId = appState.viewHistory.pop();
                console.log(`[goBack] Popped ${prevViewId} from history.`);

                // Reset relevant state based on the current view we are leaving
                if (appState.currentView === 'selection-view') {
                    // When returning from selection view, clear subsequent selections based on the level returning to
                    if (appState.selectedUnit || appState.selectedContentType === 'past') { // Returning from unit/past to content type selection
                         appState.selectedUnit = '';
                         appState.selectedContentType = '';
                         console.log('[goBack] Resetting selectedUnit and selectedContentType.');
                    } else if (appState.selectedLevel) { // Returning from content type selection to level selection
                        appState.selectedLevel = '';
                        console.log('[goBack] Resetting selectedLevel.');
                    } else if (appState.selectedCategory) { // Returning from level selection to category selection
                        appState.selectedCategory = '';
                        console.log('[goBack] Resetting selectedCategory.');
                    }
                } else if (appState.currentView === 'info-view') {
                    appState.studentName = '';
                    appState.studentClass = '';
                    console.log('[goBack] Resetting student info.');
                } else if (appState.currentView === 'confirm-role-view') {
                    appState.userRole = '';
                    console.log('[goBack] Resetting user role.');
                } else if (appState.currentView === 'test-view') {
                    resetTestState();
                    console.log('[goBack] Resetting test state from test view.');
                } else if (appState.currentView === 'results-view') {
                    resetTestState();
                    console.log('[goBack] Resetting test state from results view.');
                }

                showView(prevViewId, false); // Do not push to history again as it was just popped
                console.log(`[goBack] Navigated to previous view: ${prevViewId}`);
            } else {
                console.log('[goBack] History is empty, cannot go back.');
            }
        }


        // --- Rendering Functions for Vocabulary Selection Views ---
        /**
         * Renders the primary categories (Reading, Listening, Speaking, Writing).
         */
        function renderCategorySelection() {
            console.log('[renderCategorySelection] Starting to render category selection buttons.');
            selectionTitle.textContent = '请选择分类';
            selectionContent.innerHTML = ''; // Clear previous content
            selectionContent.classList.add('grid-col-1-md-2');

            const categories = Object.keys(vocabStructure);
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('btn-selection-item'); // Apply base styles
                if (appState.selectedCategory === category) {
                    button.classList.add('btn-selection-item-selected'); // Mark as selected
                }
                button.textContent = categoryNames[category] + ' ( ' + capitalizeFirstLetter(category) + ' )';
                button.dataset.category = category;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Category button "${category}" clicked! Event target:`, event.target);
                    appState.selectedCategory = category;
                    appState.selectedLevel = ''; // Reset next levels down
                    appState.selectedContentType = '';
                    appState.selectedUnit = '';
                    showView('selection-view'); // Re-render selection-view to next level
                });
                selectionContent.appendChild(button);
                console.log(`[renderCategorySelection] Appended button for ${category}.`);
            });
            console.log('[renderCategorySelection] Finished rendering category selection buttons.');
        }

        /**
         * Renders the secondary levels (Beginner, Intermediate, Advanced).
         * @param {string} category - The selected primary category.
         */
        function renderLevelSelection(category) {
            console.log(`[renderLevelSelection] Starting to render level selection buttons for category: ${category}.`);
            selectionTitle.textContent = `选择 ${categoryNames[category]} 难度`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-2-md-3');

            const levels = Object.keys(vocabStructure[category]);
            
            levels.forEach(level => {
                const button = document.createElement('button');
                button.classList.add('btn-selection-item');
                if (appState.selectedLevel === level) {
                    button.classList.add('btn-selection-item-selected');
                }
                button.textContent = levelNames[level] + ' ( ' + capitalizeFirstLetter(level) + ' )';
                button.dataset.level = level;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Level button "${level}" clicked! Event target:`, event.target);
                    appState.selectedLevel = level;
                    appState.selectedContentType = ''; // Reset next levels down
                    appState.selectedUnit = '';
                    showView('selection-view'); // Re-render selection-view to next level
                });
                selectionContent.appendChild(button);
                console.log(`[renderLevelSelection] Appended button for level ${level}.`);
            });
            console.log('[renderLevelSelection] Finished rendering level selection buttons.');
        }

        /**
         * Renders the third-level content type selection (By Unit, By Past Content).
         * @param {string} category - The selected primary category.
         * @param {string} level - The selected secondary level.
         */
        function renderContentTypeSelection(category, level) {
            console.log(`[renderContentTypeSelection] Starting to render content type selection buttons for ${category}-${level}.`);
            selectionTitle.textContent = `选择 ${categoryNames[category]} ${levelNames[level]} 内容类型`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-1-md-2');

            // Always display 'By Unit' button
            const unitButton = document.createElement('button');
            unitButton.classList.add('btn-selection-item');
            if (appState.selectedContentType === 'unit') {
                unitButton.classList.add('btn-selection-item-selected');
            }
            unitButton.textContent = '按照授课单元';
            unitButton.dataset.contentType = 'unit';
            unitButton.addEventListener('click', (event) => {
                console.log(`[Click] Content type button "unit" clicked! Event target:`, event.target);
                appState.selectedContentType = 'unit';
                appState.selectedUnit = '';
                showView('selection-view'); // Re-render selection-view to unit selection
            });
            selectionContent.appendChild(unitButton);
            console.log('[renderContentTypeSelection] Appended button for content type unit.');


            // Only display 'By Past Content' button if user is VIP and a past content file is defined for this category/level
            const pastFileName = vocabStructure[category]?.[level]?.past;
            if (appState.userRole === 'vip' && pastFileName) {
                const pastButton = document.createElement('button');
                pastButton.classList.add('btn-selection-item');
                if (appState.selectedContentType === 'past') {
                    pastButton.classList.add('btn-selection-item-selected');
                }
                pastButton.textContent = '按照往期内容';
                pastButton.dataset.contentType = 'past';
                pastButton.addEventListener('click', (event) => {
                    console.log(`[Click] Content type button "past" clicked! Event target:`, event.target);
                    appState.selectedContentType = 'past';
                    appState.selectedUnit = ''; // Reset unit when switching content type
                    handleFinalSelection(); // Load vocabulary and proceed to info page
                });
                selectionContent.appendChild(pastButton);
                console.log('[renderContentTypeSelection] Appended button for content type past (VIP only).');
            } else if (appState.userRole === 'class') {
                console.log('[renderContentTypeSelection] Hiding "past" option for class student as per requirement.');
            } else if (!pastFileName) {
                console.log('[renderContentTypeSelection] Hiding "past" option, no past file defined for this selection in vocabStructure.');
            }

            console.log('[renderContentTypeSelection] Finished rendering content type selection buttons.');
        }

        /**
         * Renders the unit selection (based on units configured in vocabStructure).
         * @param {string} category - The selected primary category.
         * @param {string} level - The selected secondary level.
         */
        function renderUnitSelection(category, level) {
            console.log(`[renderUnitSelection] Starting to render unit selection buttons for ${category}-${level}.`);
            selectionTitle.textContent = `选择 ${categoryNames[category]} ${levelNames[level]} 授课单元`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-3-md-5');

            const unitsAvailable = vocabStructure[category]?.[level]?.unit;
            if (!unitsAvailable || unitsAvailable.length === 0) {
                selectionContent.innerHTML = '<p class="text-gray-600">当前难度暂无单元词库。</p>';
                console.log('[renderUnitSelection] No units available for this selection.');
                return;
            }

            unitsAvailable.forEach(unitFileName => {
                const unitNumberMatch = unitFileName.match(/unit(\d+)\.json/);
                const unitNumber = unitNumberMatch ? unitNumberMatch[1] : unitFileName;

                const button = document.createElement('button');
                button.classList.add('btn-selection-item');
                 if (appState.selectedUnit === unitFileName) {
                    button.classList.add('btn-selection-item-selected');
                }
                button.textContent = `单元 ${unitNumber}`;
                button.dataset.unit = unitFileName;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Unit button "${unitFileName}" clicked! Event target:`, event.target);
                    appState.selectedUnit = unitFileName;
                    handleFinalSelection(); // Load vocabulary and proceed to info page
                });
                selectionContent.appendChild(button);
                console.log(`[renderUnitSelection] Appended button for unit ${unitNumber}.`);
            });
            console.log('[renderUnitSelection] Finished rendering unit selection buttons.');
        }

        /**
         * Handles the final selection and loads vocabulary data.
         */
        async function handleFinalSelection() {
            console.log('[handleFinalSelection] Starting vocabulary loading...');
            let jsonFileName = '';
            if (appState.selectedContentType === 'unit') {
                jsonFileName = appState.selectedUnit;
            } else { // 'past'
                jsonFileName = vocabStructure[appState.selectedCategory][appState.selectedLevel].past;
            }
            const jsonPath = `data/${jsonFileName}`;
            console.log(`[handleFinalSelection] Attempting to load JSON from: ${jsonPath}`);

            selectionContent.innerHTML = '<p class="text-xl text-gray-600 animate-pulse">加载词汇中，请稍候...</p>';
            selectionContent.classList.remove('grid-col-1-md-2', 'grid-col-2-md-3', 'grid-col-3-md-5');
            selectionContent.classList.add('flex', 'justify-center', 'items-center', 'py-10');


            try {
                const response = await fetch(jsonPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${jsonPath}`);
                }
                appState.currentTestVocabulary = await response.json();

                if (!appState.currentTestVocabulary || appState.currentTestVocabulary.length === 0) {
                    console.warn('[handleFinalSelection] Loaded vocabulary is empty.');
                    // Using custom modal for alerts
                    showModal('所选词库为空，请选择其他词库或联系老师添加词汇。');
                    goBack();
                    return;
                }

                console.log('[handleFinalSelection] Loaded vocabulary for test:', appState.currentTestVocabulary);
                showView('info-view'); // Proceed to student info view

            } catch (error) {
                console.error('[handleFinalSelection] Vocabulary loading error:', error);
                // Using custom modal for alerts
                showModal(`加载词库失败: ${error.message}。请检查以下文件是否存在且格式正确: ${jsonPath}。`);
                goBack();
            }
        }

        /**
         * Resets all test-related state data.
         */
        function resetTestState() {
            console.log('[resetTestState] Resetting all test-related state.');
            appState.currentTestVocabulary = [];
            appState.shuffledTestVocabulary = [];
            appState.currentWordIndex = 0;
            appState.correctAnswersCount = 0;
            appState.questionsAttempted = 0;
            appState.incorrectAnswers = [];
            appState.testStartTime = null;
        }

        // --- Dictation Test Core Logic ---
        function initializeTestLogic() {
            console.log('[initializeTestLogic] Initializing test logic...');
            appState.shuffledTestVocabulary = shuffleArray([...appState.currentTestVocabulary]);
            appState.currentWordIndex = 0;
            appState.correctAnswersCount = 0;
            appState.questionsAttempted = 0;
            appState.incorrectAnswers = [];
            appState.testStartTime = new Date();

            // Ensure test view UI elements are correctly visible at the start of a new test
            answerInput.classList.remove('hidden');
            getExampleBtn.classList.remove('hidden');
            checkAnswerBtn.classList.remove('hidden');
            nextWordBtn.classList.add('hidden'); // Hide next button initially
            endTestBtn.classList.remove('hidden'); // Ensure end test button is always visible during test
            feedbackMessage.classList.remove('hidden');
            exampleSentenceDisplay.classList.remove('hidden');

            loadQuestion();
            console.log('[initializeTestLogic] Test initialized and first question loaded.');
        }

        function loadQuestion() {
            console.log(`[loadQuestion] Loading question ${appState.currentWordIndex + 1} / ${appState.shuffledTestVocabulary.length}...`);

            // Check if all unique words in the shuffled list have been presented
            if (appState.currentWordIndex >= appState.shuffledTestVocabulary.length) {
                // All words completed for this shuffled session
                questionDisplay.textContent = '已完成全部词汇测验！';
                answerInput.value = ''; // Clear input
                answerInput.classList.add('hidden'); // Hide input
                answerInput.readOnly = true; // Make sure it's read-only
                feedbackMessage.textContent = '请点击 "结束测试" 查看结果。';
                feedbackMessage.classList.remove('text-green-600', 'text-red-600');
                exampleSentenceDisplay.textContent = ''; // Clear example
                exampleSentenceDisplay.classList.add('hidden'); // Hide example display
                getExampleBtn.classList.add('hidden'); // Hide example button
                checkAnswerBtn.classList.add('hidden'); // Hide check button
                nextWordBtn.classList.add('hidden'); // Hide next button
                // endTestBtn is already visible in initializeTestLogic and should remain so

                console.log('[loadQuestion] All vocabulary completed. Prompting user to end test.');
                return; // Stop loading new questions
            }

            // Normal loading of a question
            const currentPair = appState.shuffledTestVocabulary[appState.currentWordIndex];
            questionDisplay.textContent = currentPair.chinese;
            answerInput.value = '';
            // Ensure input is visible and active for new question
            answerInput.classList.remove('feedback-correct', 'feedback-incorrect', 'hidden');
            answerInput.readOnly = false;
            answerInput.focus();
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600');
            nextWordBtn.classList.add('hidden'); // Hide next button until answered
            checkAnswerBtn.classList.remove('hidden'); // Show check button
            getExampleBtn.classList.remove('hidden'); // Ensure get example button is visible
            exampleSentenceDisplay.textContent = '点击 "获取例句" 查看上下文'; // Reset example sentence
            exampleSentenceDisplay.classList.remove('hidden'); // Ensure example display is visible
            getExampleBtn.disabled = false;
            console.log(`[loadQuestion] Displaying Chinese: "${currentPair.chinese}"`);
        }

        function checkCurrentAnswer() {
            console.log('[checkCurrentAnswer] Checking answer...');
            appState.questionsAttempted++;
            const typedAnswer = answerInput.value.trim();
            const correctEnglish = appState.shuffledTestVocabulary[appState.currentWordIndex].english.trim();

            answerInput.readOnly = true;
            getExampleBtn.disabled = true;

            if (typedAnswer.toLowerCase() === correctEnglish.toLowerCase()) {
                feedbackMessage.textContent = '正确！👍';
                feedbackMessage.classList.remove('text-red-600');
                feedbackMessage.classList.add('text-green-600');
                answerInput.classList.add('feedback-correct');
                appState.correctAnswersCount++;
                playPronunciation(correctEnglish);
                console.log('[checkCurrentAnswer] Answer correct.');
            } else {
                feedbackMessage.innerHTML = `错误！正确答案是: "${correctEnglish}"`;
                feedbackMessage.appendChild(createPlayButton(correctEnglish));
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-600');
                answerInput.classList.add('feedback-incorrect');
                appState.incorrectAnswers.push({
                    chinese: appState.shuffledTestVocabulary[appState.currentWordIndex].chinese,
                    typed: typedAnswer,
                    correct: correctEnglish
                });
                console.log(`[checkCurrentAnswer] Answer incorrect. Correct: "${correctEnglish}", Typed: "${typedAnswer}"`);
            }

            checkAnswerBtn.classList.add('hidden'); // Hide check button
            // Only show next word button if not all words are completed
            if (appState.currentWordIndex < appState.shuffledTestVocabulary.length) {
                nextWordBtn.classList.remove('hidden');
            }
            console.log('[checkCurrentAnswer] Answer checked. Ready for next word or end test.');
        }

        function nextWord() {
            console.log('[nextWord] Moving to next word...');
            appState.currentWordIndex++;
            loadQuestion();
        }

        async function endTestSession() {
            console.log('[endTestSession] Ending test session and saving results...');
            
            // Collect test results
            const testResult = {
                studentName: appState.studentName,
                studentClass: appState.studentClass,
                userRole: appState.userRole,
                category: appState.selectedCategory,
                level: appState.selectedLevel,
                contentType: appState.selectedContentType,
                unit: appState.selectedUnit,
                correctAnswers: appState.correctAnswersCount,
                totalQuestions: appState.questionsAttempted,
                accuracy: appState.questionsAttempted > 0 ? (appState.correctAnswersCount / appState.questionsAttempted) * 100 : 0,
                incorrectAnswersDetails: JSON.stringify(appState.incorrectAnswers), // Store as string for Firestore
                timestamp: serverTimestamp(), // Use Firestore's server timestamp
                userId: appState.userId // Store Firebase User ID
            };

            // Save to Firestore
            if (db && authReady) { // Ensure Firestore and Auth are ready
                try {
                    // Store in public collection for broader access if needed, or specific user's private collection
                    // For now, let's use a public collection that you can read from as the teacher
                    const collectionPath = `artifacts/${appId}/public/data/studentReports`;
                    const docRef = await addDoc(collection(db, collectionPath), testResult);
                    console.log("[Firestore] Document written with ID: ", docRef.id);
                    // Optionally, show a success message to the student
                    // showModal('测试报告已成功保存！');
                } catch (e) {
                    console.error("[Firestore] Error adding document: ", e);
                    // showModal('保存测试报告失败，请检查网络或联系老师。');
                }
            } else {
                console.warn("[Firestore] Firestore not initialized or Auth not ready. Test results will not be saved.");
                // showModal('报告无法保存，请检查网络或稍后再试。');
            }

            showView('results-view');
        }

        function renderFinalResults() {
            console.log('[renderFinalResults] Rendering final results...');
            // Hide all interactive elements from the test view
            answerInput.classList.add('hidden');
            getExampleBtn.classList.add('hidden');
            checkAnswerBtn.classList.add('hidden');
            nextWordBtn.classList.add('hidden');
            endTestBtn.classList.add('hidden');
            feedbackMessage.classList.add('hidden');
            exampleSentenceDisplay.classList.add('hidden');


            // Populate results summary
            summaryName.textContent = appState.studentName || '未填写';
            if (appState.userRole === 'class') {
                summaryClassRow.classList.remove('hidden');
                summaryClass.textContent = appState.studentClass || '未填写';
            } else {
                summaryClassRow.classList.add('hidden');
            }
            summaryDate.textContent = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let accuracy = 0;
            if (appState.questionsAttempted > 0) {
                accuracy = (appState.correctAnswersCount / appState.questionsAttempted) * 100;
            }
            summaryAccuracy.textContent = `${accuracy.toFixed(2)}% (${appState.correctAnswersCount} / ${appState.questionsAttempted})`;
            
            incorrectCountSpan.textContent = appState.incorrectAnswers.length;

            // Populate list of incorrect answers
            resultsList.innerHTML = '';
            if (appState.incorrectAnswers.length === 0) {
                resultsList.innerHTML = '<p class="text-green-700 font-semibold">太棒了！所有题目都正确！</p>';
                console.log('[renderFinalResults] All answers correct!');
            } else {
                appState.incorrectAnswers.forEach(item => {
                    const li = document.createElement('li');
                    li.classList.add('mb-2', 'pb-2', 'border-b', 'border-gray-200', 'flex', 'flex-col');
                    li.innerHTML = `
                        <p><strong>中文:</strong> ${item.chinese}</p>
                        <p class="flex items-center"><strong>您输入:</strong> <span class="text-red-600">${item.typed || '[未输入]'}</span></p>
                        <p class="flex items-center"><strong>正确答案:</strong> <span class="text-green-600">${item.correct}</span></p>
                    `;
                    const correctSpan = li.querySelector('.text-green-600');
                    if (correctSpan) {
                        correctSpan.parentNode.appendChild(createPlayButton(item.correct));
                    }
                    resultsList.appendChild(li);
                });
                console.log(`[renderFinalResults] Displaying ${appState.incorrectAnswers.length} incorrect answers.`);
            }
            console.log('[renderFinalResults] Results rendering complete.');
        }

        // --- Speech Synthesis and LLM Example Sentence Functions ---

        /**
         * Plays the pronunciation of a given word.
         * @param {string} word - The word to pronounce.
         */
        function playPronunciation(word) {
            console.log(`[playPronunciation] Attempting to play: "${word}"`);
            if (!speechSynth || !voicesLoaded) {
                console.warn('SpeechSynthesis API not ready or supported in this browser. Pronunciation will not work.');
                return;
            }
            if (speechSynth.speaking) {
                speechSynth.cancel();
                console.log('[playPronunciation] Cancelling previous speech.');
            }
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            utterance.volume = 1;
            utterance.rate = 1;
            utterance.pitch = 1;
            speechSynth.speak(utterance);
            console.log(`[playPronunciation] Spoke: "${word}"`);
        }

        /**
         * Creates and returns a play button element.
         * @param {string} wordToSpeak - The word to be spoken when the button is clicked.
         * @returns {HTMLButtonElement} The play button element.
         */
        function createPlayButton(wordToSpeak) {
            const button = document.createElement('button');
            button.classList.add('play-button');
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            button.title = `播放 "${wordToSpeak}" 的发音`;
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                playPronunciation(wordToSpeak);
            });
            return button;
        }

        /**
         * Generates an example sentence using the Gemini API (gemini-2.0-flash).
         */
        async function getExampleSentence() {
            console.log('[getExampleSentence] Attempting to get example sentence...');
            const currentPair = appState.shuffledTestVocabulary[appState.currentWordIndex];
            const englishWord = currentPair.english;

            const isAnswerEmpty = answerInput.value.trim() === '';
            const isAnswerChecked = answerInput.readOnly;
            const isAnswerCorrect = answerInput.classList.contains('feedback-correct');

            if (isAnswerEmpty && !isAnswerChecked) {
                showModal('请输入英文词汇或短语后再获取例句。');
                console.warn('[getExampleSentence] Answer input is empty, cannot get example.');
                return;
            } else if (isAnswerChecked && !isAnswerCorrect) {
                 showModal('请检查您的答案（红色部分），并查看正确答案，再获取例句。');
                 console.warn('[getExampleSentence] Answer incorrect and checked, guiding user to correct first.');
                 return;
            }

            exampleSentenceDisplay.innerHTML = '<div class="loading-spinner"></div>';
            getExampleBtn.disabled = true;
            console.log(`[getExampleSentence] Prompting LLM for example of: "${englishWord}"`);

            try {
                const prompt = `请提供一个关于英文词汇或短语 "${englishWord}" 的例句。例句需适合中级英语学习者，且句子内容避免过于简单或过于复杂。`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    exampleSentenceDisplay.textContent = `例句: "${text}"`;
                    console.log(`[getExampleSentence] LLM example received: "${text}"`);
                } else {
                    exampleSentenceDisplay.textContent = '无法生成例句。请稍后再试。';
                    console.error('[getExampleSentence] LLM response structure unexpected:', result);
                }
            } catch (error) {
                exampleSentenceDisplay.textContent = '获取例句失败。请检查网络或稍后再试。';
                console.error('[getExampleSentence] Error calling LLM API:', error);
            } finally {
                if (!answerInput.readOnly) {
                    getExampleBtn.disabled = false;
                }
                console.log('[getExampleSentence] Example sentence request finished.');
            }
        }


        // --- Helper Mapping Objects (for display) ---
        const categoryNames = {
            reading: '阅读', listening: '听力', speaking: '口语', writing: '写作'
        };
        const levelNames = {
            beginner: '初级', intermediate: '中级', advanced: '高级'
        };
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // --- Speech Synthesis Initialization ---
        if (speechSynth) {
            speechSynth.onvoiceschanged = () => {
                voicesLoaded = true;
                console.log('[SpeechSynthesis] Voices loaded.');
            };
            if (speechSynth.getVoices().length > 0) {
                voicesLoaded = true;
                console.log('[SpeechSynthesis] Voices already available.');
            }
        } else {
            console.warn('[SpeechSynthesis] 浏览器不支持 SpeechSynthesis API。发音功能将不可用。');
        }

        /**
         * Utility function to shuffle an array.
         * @param {Array} array
         * @returns {Array}
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Custom Modal Function (replaces alert/confirm) ---
        function showModal(message) {
            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p class="text-lg font-semibold mb-6">${message}</p>
                        <button id="modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition duration-200">确定</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('modal-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-modal').remove();
            });
        }


        // --- Event Listeners ---
        vipStudentBtn.addEventListener('click', () => {
            console.log('[Event] VIP Student button clicked.');
            appState.userRole = 'vip';
            showView('confirm-role-view');
        });

        classStudentBtn.addEventListener('click', () => {
            console.log('[Event] Class Student button clicked.');
            appState.userRole = 'class';
            showView('confirm-role-view');
        });

        confirmBackBtn.addEventListener('click', goBack);

        confirmRoleContinueBtn.addEventListener('click', () => {
            console.log('[Event] Confirm Role Continue button clicked.');
            appState.viewHistory = []; // From confirm-role-view, always start a fresh history for selection
            showView('selection-view');
        });

        selectionBackBtn.addEventListener('click', goBack);

        // Start Test button on student info page
        startTestBtn.addEventListener('click', () => {
            console.log('[Event] Start Test button clicked.');
            appState.studentName = studentNameInput.value.trim();
            if (appState.userRole === 'class') {
                appState.studentClass = studentClassInput.value.trim();
            } else {
                appState.studentClass = ''; // VIP students don't have a class
            }

            if (!appState.studentName) {
                showModal('请输入您的姓名才能开始测试！');
                console.warn('[Event] Student name not entered.');
                return;
            }
            showView('test-view'); // Navigate to the test view
        });
        infoBackBtn.addEventListener('click', goBack);

        // Buttons for the dictation test view
        checkAnswerBtn.addEventListener('click', checkCurrentAnswer);
        nextWordBtn.addEventListener('click', nextWord);
        endTestBtn.addEventListener('click', endTestSession); // Call function to end test session
        getExampleBtn.addEventListener('click', getExampleSentence);
        testBackBtn.addEventListener('click', goBack); // Back button for test view

        // Restart button for the results view
        resultsRestartBtn.addEventListener('click', () => {
            console.log('[Event] Restart Test button clicked.');
            // Clear all selections and go back to the welcome screen to restart the entire flow
            appState.userRole = '';
            appState.selectedCategory = '';
            appState.selectedLevel = '';
            appState.selectedContentType = '';
            appState.selectedUnit = '';
            appState.studentName = '';
            appState.studentClass = '';
            resetTestState(); // Completely reset test-related state
            showView('welcome-view');
        });
        resultsBackBtn.addEventListener('click', goBack); // Back button for results view


        // Allow pressing Enter key to check answer or move to next
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                console.log('[Event] Enter key pressed on answer input.');
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkCurrentAnswer();
                } else if (!nextWordBtn.classList.contains('hidden')) {
                    nextWord();
                }
            }
        });


        // --- Application Startup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[App Startup] DOMContentLoaded fired. Initializing view.');
            showView('welcome-view', false); // Display welcome view by default, do not push to history
        });
    </script>
</body>
</html>
