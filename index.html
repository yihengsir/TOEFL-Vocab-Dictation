<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEFL è¯æ±‡æµ‹è¯• - å®Œæ•´ç‰ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for speaker icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles and utility classes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* æ›´æŸ”å’Œçš„èƒŒæ™¯è‰² */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem; /* å¢åŠ æ•´ä½“å†…è¾¹è· */
            overflow-y: auto;
        }

        .main-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* æ›´å¤§çš„åœ†è§’ */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); /* æ›´æ˜æ˜¾çš„é˜´å½± */
            padding: 2.5rem 3rem; /* å¢åŠ å†…è¾¹è· */
            width: 100%;
            max-width: 800px; /* é€‚å½“å¢åŠ æœ€å¤§å®½åº¦ */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* å¢åŠ æ¨¡å—é—´è· */
            text-align: center;
            position: relative; /* ç”¨äºè¿”å›æŒ‰é’®çš„å®šä½ */
        }

        /* æ‰€æœ‰è§†å›¾å…±äº«çš„æ ·å¼ */
        .view {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* è§†å›¾å†…éƒ¨å…ƒç´ é—´è· */
            /* è°ƒè¯• CSS: ç¡®ä¿è§†å›¾åœ¨æœ€ä¸Šå±‚ä¸”å¯äº¤äº’ */
            position: relative; /* ç¡®ä¿ z-index æœ‰æ•ˆ */
            z-index: 10; /* ç¡®ä¿è§†å›¾å±‚çº§é«˜äºå…¶ä»–æ½œåœ¨é®ç›–ç‰© */
            pointer-events: auto; /* ç¡®ä¿è¯¥å…ƒç´ åŠå…¶å­å…ƒç´ å¯äº¤äº’ */
        }

        /* æ ‡é¢˜æ ·å¼ */
        .view-title {
            @apply text-3xl md:text-4xl font-extrabold text-gray-800 mb-6; /* æ›´æ·±çš„é¢œè‰²ï¼Œæ›´ç²—çš„å­—ä½“ */
        }

        /* ä¸»è¦æŒ‰é’®æ ·å¼ */
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-xl transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 w-2/3 md:w-1/2 mx-auto;
            letter-spacing: 0.05em; /* å¢åŠ å­—æ¯é—´è· */
            pointer-events: auto; /* æ˜ç¡®è®¾ç½®ä¸ºå¯äº¤äº’ */
            z-index: 20; /* ç¡®ä¿æŒ‰é’®å±‚çº§é«˜äºå…¶å®¹å™¨ */
        }

        /* æ¬¡è¦æŒ‰é’®/é€‰æ‹©é¡¹æ ·å¼ (å¡ç‰‡åŒ–) */
        .btn-selection-item {
            @apply bg-white border border-gray-200 text-gray-800 font-semibold py-4 px-6 rounded-xl shadow-md cursor-pointer transition duration-200 hover:bg-gray-50 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-400;
            text-align: center;
            min-height: 80px; /* ç¡®ä¿æŒ‰é’®æœ‰è¶³å¤Ÿé«˜åº¦ï¼Œå†…å®¹ä¸ä¼šå¤ªæŒ¤ */
            display: flex; /* ä½¿ç”¨flexå¸ƒå±€è®©å†…å®¹å‚ç›´å±…ä¸­ */
            align-items: center;
            justify-content: center;
            pointer-events: auto; /* æ˜ç¡®è®¾ç½®ä¸ºå¯äº¤äº’ */
            z-index: 20; /* ç¡®ä¿æŒ‰é’®å±‚çº§é«˜äºå…¶å®¹å™¨ */
        }

        .btn-selection-item-selected {
            @apply bg-blue-500 text-white border-blue-500 shadow-xl ring-2 ring-blue-300;
        }
        .btn-selection-item-selected:hover {
             @apply bg-blue-600; /* é€‰ä¸­çŠ¶æ€ä¸‹ hover é¢œè‰²ç¨å¾®å˜æ·± */
        }

        /* è¿”å›æŒ‰é’®æ ·å¼ */
        .btn-back {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full shadow-md transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-200 absolute top-6 left-6 z-10;
            pointer-events: auto; /* æ˜ç¡®è®¾ç½®ä¸ºå¯äº¤äº’ */
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* ä¸åŒçš„é€‰æ‹©ç½‘æ ¼å¸ƒå±€ */
        .grid-layout {
            @apply grid gap-4 w-full; /* åŸºç¡€ç½‘æ ¼é—´è· */
            pointer-events: auto; /* ç¡®ä¿ç½‘æ ¼å®¹å™¨å¯äº¤äº’ */
            z-index: 15; /* ç¡®ä¿ç½‘æ ¼å®¹å™¨å±‚çº§é«˜äºå…¶ä»–æ½œåœ¨é®ç›–ç‰© */
        }
        .grid-col-1-md-2 {
            @apply grid-cols-1 md:grid-cols-2;
        }
        .grid-col-2-md-3 {
            @apply grid-cols-2 md:grid-cols-3;
        }
        .grid-col-3-md-5 {
            @apply grid-cols-3 md:grid-cols-5;
        }

        /* é¢å¤–ä¼˜åŒ–ï¼šè¾“å…¥æ¡†æ ·å¼ */
        .input-field {
            @apply block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm text-lg text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200;
        }

        /* å¬å†™æµ‹è¯•ç‰¹å®šæ ·å¼ */
        .quiz-question-display {
            @apply bg-blue-100 text-blue-900 text-3xl font-bold py-6 px-4 rounded-lg shadow-inner;
        }
        .quiz-input-field {
            @apply border-2 border-gray-300 rounded-lg p-3 text-xl w-full text-center;
        }
        .feedback-correct {
            @apply bg-green-100 border-green-500 text-green-800;
        }
        .feedback-incorrect {
            @apply bg-red-100 border-red-500 text-red-800;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .play-button {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
            padding: 0;
            vertical-align: middle;
            transition: color 0.2s;
        }
        .play-button:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="app-container" class="main-container">
        <!-- æ¬¢è¿/è§’è‰²é€‰æ‹©è§†å›¾ -->
        <div id="welcome-view" class="view">
            <h1 class="view-title">
                TOEFL è¯æ±‡ç»ƒä¹ 
            </h1>
            <p class="text-xl text-gray-700 mb-8">è¯·é€‰æ‹©æ‚¨çš„èº«ä»½ï¼š</p>
            <button id="vip-student-btn" class="btn-primary">æˆ‘æ˜¯ VIP å­¦ç”Ÿ</button>
            <button id="class-student-btn" class="btn-primary">æˆ‘æ˜¯ç­è¯¾å­¦ç”Ÿ</button>
        </div>

        <!-- èº«ä»½ç¡®è®¤è§†å›¾ -->
        <div id="confirm-role-view" class="view hidden">
            <button id="confirm-back-btn" class="btn-back">è¿”å›</button>
            <h2 class="view-title">
                ç¡®è®¤æ‚¨çš„èº«ä»½
            </h2>
            <p id="confirm-role-text" class="text-xl text-purple-700 font-semibold mb-8">
                æ‚¨å·²é€‰æ‹©ï¼š<span id="confirmed-role"></span>
            </p>
            <button id="confirm-role-continue-btn" class="btn-primary bg-purple-600 hover:bg-purple-700 focus:ring-purple-300">ç»§ç»­</button>
        </div>

        <!-- è¯åº“é€‰æ‹©è§†å›¾ -->
        <div id="selection-view" class="view hidden">
            <button id="selection-back-btn" class="btn-back">è¿”å›</button>
            <h2 id="selection-title" class="view-title">
                è¯·é€‰æ‹©åˆ†ç±»
            </h2>
            <div id="selection-content" class="grid-layout grid-col-1-md-2">
                <!-- åŠ¨æ€å†…å®¹ä¼šå¡«å……åœ¨è¿™é‡Œ -->
            </div>
        </div>

        <!-- å­¦ç”Ÿä¿¡æ¯å¡«å†™è§†å›¾ -->
        <div id="info-view" class="view hidden">
            <button id="info-back-btn" class="btn-back">è¿”å›</button>
            <h2 class="view-title">
                å¡«å†™å­¦ç”Ÿä¿¡æ¯
            </h2>
            <input type="text" id="student-name-input" class="input-field mb-4" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" />
            <input type="text" id="student-class-input" class="input-field mb-6 hidden" placeholder="è¯·è¾“å…¥æ‚¨çš„ç­çº§ (ç­è¯¾å­¦ç”Ÿ)" />
            <button id="start-test-btn" class="btn-primary">å¼€å§‹æµ‹è¯•</button>
        </div>

        <!-- å¬å†™æµ‹è¯•è§†å›¾ -->
        <div id="test-view" class="view hidden">
            <button id="test-back-btn" class="btn-back">è¿”å›</button>
            <h2 class="view-title">
                å¬å†™æµ‹è¯•
            </h2>
            <div id="quiz-area" class="flex flex-col gap-6 w-full">
                <div id="question-display" class="quiz-question-display">
                    åŠ è½½è¯æ±‡...
                </div>

                <input type="text" id="answer-input" class="quiz-input-field" placeholder="åœ¨æ­¤è¾“å…¥è‹±æ–‡è¯æ±‡æˆ–çŸ­è¯­..." autofocus>

                <div id="example-sentence-display" class="bg-gray-50 p-4 rounded-lg shadow-inner text-gray-700 text-sm italic min-h-[60px] flex items-center justify-center">
                    ç‚¹å‡» "è·å–ä¾‹å¥" æŸ¥çœ‹ä¸Šä¸‹æ–‡
                </div>

                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button id="get-example-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
                        è·å–ä¾‹å¥
                    </button>
                    <button id="check-answer-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        æ£€æŸ¥ç­”æ¡ˆ
                    </button>
                    <button id="next-word-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 hidden">
                        ä¸‹ä¸€ä¸ª
                    </button>
                </div>

                <div class="flex justify-center mt-4">
                    <button id="end-test-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                        ç»“æŸæµ‹è¯•
                    </button>
                </div>

                <div id="feedback-message" class="text-lg font-semibold min-h-[30px]"></div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœè§†å›¾ -->
        <div id="results-view" class="view hidden">
            <button id="results-back-btn" class="btn-back">è¿”å›</button>
            <h2 class="view-title">
                æµ‹è¯•ç»“æœ
            </h2>
            <div id="test-summary" class="text-left text-lg text-gray-800 mb-6">
                <p><strong>å§“å:</strong> <span id="summary-name"></span></p>
                <p id="summary-class-row"><strong>ç­çº§:</strong> <span id="summary-class"></span></p>
                <p><strong>æ—¥æœŸ:</strong> <span id="summary-date"></span></p>
                <p><strong>æ­£ç¡®ç‡:</strong> <span id="summary-accuracy" class="font-bold"></span></p>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                ç­”é”™é¢˜ç›®åˆ—è¡¨ (<span id="incorrect-count">0</span> é¢˜)
            </h3>
            <div id="results-list" class="text-left bg-gray-50 p-4 rounded-lg shadow-inner w-full max-h-96 overflow-y-auto"></div>
            <button id="results-restart-btn" class="btn-primary mt-8">é‡æ–°å¼€å§‹ç»ƒä¹ </button>
        </div>
    </div>

    <script>
        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const appContainer = document.getElementById('app-container');
        const welcomeView = document.getElementById('welcome-view');
        const confirmRoleView = document.getElementById('confirm-role-view');
        const selectionView = document.getElementById('selection-view');
        const infoView = document.getElementById('info-view');
        const testView = document.getElementById('test-view');
        const resultsView = document.getElementById('results-view');

        const vipStudentBtn = document.getElementById('vip-student-btn');
        const classStudentBtn = document.getElementById('class-student-btn');

        const confirmBackBtn = document.getElementById('confirm-back-btn');
        const confirmedRoleSpan = document.getElementById('confirmed-role');
        const confirmRoleContinueBtn = document.getElementById('confirm-role-continue-btn');

        const selectionBackBtn = document.getElementById('selection-back-btn');
        const selectionTitle = document.getElementById('selection-title');
        const selectionContent = document.getElementById('selection-content');

        const studentNameInput = document.getElementById('student-name-input');
        const studentClassInput = document.getElementById('student-class-input');
        const startTestBtn = document.getElementById('start-test-btn');
        const infoBackBtn = document.getElementById('info-back-btn');

        // Test View specific elements
        const questionDisplay = document.getElementById('question-display');
        const answerInput = document.getElementById('answer-input');
        const getExampleBtn = document.getElementById('get-example-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextWordBtn = document.getElementById('next-word-btn');
        const endTestBtn = document.getElementById('end-test-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const exampleSentenceDisplay = document.getElementById('example-sentence-display');
        const testBackBtn = document.getElementById('test-back-btn');

        // Results View specific elements
        const summaryName = document.getElementById('summary-name');
        const summaryClass = document.getElementById('summary-class');
        const summaryClassRow = document.getElementById('summary-class-row');
        const summaryDate = document.getElementById('summary-date');
        const summaryAccuracy = document.getElementById('summary-accuracy');
        const incorrectCountSpan = document.getElementById('incorrect-count');
        const resultsList = document.getElementById('results-list');
        const resultsRestartBtn = document.getElementById('results-restart-btn');
        const resultsBackBtn = document.getElementById('results-back-btn');


        // --- å…¨å±€åº”ç”¨çŠ¶æ€ ---
        const appState = {
            currentView: 'welcome-view', // å½“å‰æ˜¾ç¤ºçš„è§†å›¾ID
            userRole: '', // 'vip' æˆ– 'class'
            selectedCategory: '', // 'reading', 'listening', 'speaking', 'writing'
            selectedLevel: '',    // 'beginner', 'intermediate', 'advanced'
            selectedContentType: '',  // 'unit' æˆ– 'past'
            selectedUnit: '',     // 'unit1' åˆ° 'unit10'
            studentName: '',
            studentClass: '',
            viewHistory: [], // ç”¨äºè¿½è¸ªè§†å›¾å†å²ï¼Œæ–¹ä¾¿è¿”å›
            currentTestVocabulary: [], // å­˜å‚¨å½“å‰æµ‹è¯•çš„è¯æ±‡æ•°æ®
            shuffledTestVocabulary: [], // å½“å‰æµ‹è¯•æ‰“ä¹±åçš„è¯æ±‡é¡ºåº
            currentWordIndex: 0,
            correctAnswersCount: 0,
            questionsAttempted: 0,
            incorrectAnswers: [], // å­˜å‚¨ç­”é”™çš„é¢˜ç›®è¯¦æƒ…
            testStartTime: null, // è®°å½•æµ‹è¯•å¼€å§‹æ—¶é—´
        };

        // --- è¯åº“ç»“æ„æ˜ å°„ï¼ˆæŒ‡å‘å®é™…çš„JSONæ–‡ä»¶è·¯å¾„ï¼‰ ---
        const vocabStructure = {
            reading: {
                beginner: {
                    unit: ['reading_beginner_unit1.json', 'reading_beginner_unit2.json', 'reading_beginner_unit3.json', 'reading_beginner_unit4.json', 'reading_beginner_unit5.json', 'reading_beginner_unit6.json', 'reading_beginner_unit7.json', 'reading_beginner_unit8.json', 'reading_beginner_unit9.json', 'reading_beginner_unit10.json'],
                    past: 'expressions.json' // å°† expressions.json æ˜ å°„åˆ°è¿™é‡Œ
                },
                intermediate: {
                    unit: ['reading_intermediate_unit1.json', 'reading_intermediate_unit2.json', 'reading_intermediate_unit3.json', 'reading_intermediate_unit4.json', 'reading_intermediate_unit5.json', 'reading_intermediate_unit6.json', 'reading_intermediate_unit7.json', 'reading_intermediate_unit8.json', 'reading_intermediate_unit9.json', 'reading_intermediate_unit10.json'],
                    past: 'reading_intermediate_past.json'
                },
                advanced: {
                    unit: ['reading_advanced_unit1.json', 'reading_advanced_unit2.json', 'reading_advanced_unit3.json', 'reading_advanced_unit4.json', 'reading_advanced_unit5.json', 'reading_advanced_unit6.json', 'reading_advanced_unit7.json', 'reading_advanced_unit8.json', 'reading_advanced_unit9.json', 'reading_advanced_unit10.json'],
                    past: 'reading_advanced_past.json'
                }
            },
            listening: {
                // æ ¹æ®æ‚¨ä¸Šä¼ çš„å®é™…æ–‡ä»¶ï¼Œå°†æ‰€æœ‰å•å…ƒæ‰©å±•åˆ°10ä¸ª
                beginner: { unit: ['listening_beginner_unit1.json', 'listening_beginner_unit2.json', 'listening_beginner_unit3.json', 'listening_beginner_unit4.json', 'listening_beginner_unit5.json', 'listening_beginner_unit6.json', 'listening_beginner_unit7.json', 'listening_beginner_unit8.json', 'listening_beginner_unit9.json', 'listening_beginner_unit10.json'], past: 'listening_beginner_past.json' },
                intermediate: { unit: ['listening_intermediate_unit1.json', 'listening_intermediate_unit2.json', 'listening_intermediate_unit3.json', 'listening_intermediate_unit4.json', 'listening_intermediate_unit5.json', 'listening_intermediate_unit6.json', 'listening_intermediate_unit7.json', 'listening_intermediate_unit8.json', 'listening_intermediate_unit9.json', 'listening_intermediate_unit10.json'], past: 'listening_intermediate_past.json' },
                advanced: { unit: ['listening_advanced_unit1.json', 'listening_advanced_unit2.json', 'listening_advanced_unit3.json', 'listening_advanced_unit4.json', 'listening_advanced_unit5.json', 'listening_advanced_unit6.json', 'listening_advanced_unit7.json', 'listening_advanced_unit8.json', 'listening_advanced_unit9.json', 'listening_advanced_unit10.json'], past: 'listening_advanced_past.json' }
            },
            speaking: {
                // æ ¹æ®æ‚¨ä¸Šä¼ çš„å®é™…æ–‡ä»¶ï¼Œå°†æ‰€æœ‰å•å…ƒæ‰©å±•åˆ°10ä¸ª
                beginner: { unit: ['speaking_beginner_unit1.json', 'speaking_beginner_unit2.json', 'speaking_beginner_unit3.json', 'speaking_beginner_unit4.json', 'speaking_beginner_unit5.json', 'speaking_beginner_unit6.json', 'speaking_beginner_unit7.json', 'speaking_beginner_unit8.json', 'speaking_beginner_unit9.json', 'speaking_beginner_unit10.json'], past: 'speaking_beginner_past.json' },
                intermediate: { unit: ['speaking_intermediate_unit1.json', 'speaking_intermediate_unit2.json', 'speaking_intermediate_unit3.json', 'speaking_intermediate_unit4.json', 'speaking_intermediate_unit5.json', 'speaking_intermediate_unit6.json', 'speaking_intermediate_unit7.json', 'speaking_intermediate_unit8.json', 'speaking_intermediate_unit9.json', 'speaking_intermediate_unit10.json'], past: 'speaking_intermediate_past.json' },
                advanced: { unit: ['speaking_advanced_unit1.json', 'speaking_advanced_unit2.json', 'speaking_advanced_unit3.json', 'speaking_advanced_unit4.json', 'speaking_advanced_unit5.json', 'speaking_advanced_unit6.json', 'speaking_advanced_unit7.json', 'speaking_advanced_unit8.json', 'speaking_advanced_unit9.json', 'speaking_advanced_unit10.json'], past: 'speaking_advanced_past.json' }
            },
            writing: {
                beginner: { unit: ['writing_beginner_unit1.json'], past: 'writing_beginner_past.json' },
                intermediate: { unit: ['writing_intermediate_unit1.json'], past: 'writing_intermediate_past.json' },
                advanced: { unit: ['writing_advanced_unit1.json'], past: 'writing_advanced_past.json' }
            }
        };

        // LLM API Key (ç•™ç©ºï¼ŒGitHub Pages ä¸Šéƒ¨ç½²éœ€è¦æ‚¨æ‰‹åŠ¨å¡«å…¥)
        const apiKey = "";
        let speechSynth = window.speechSynthesis;
        let voicesLoaded = false;


        // --- æ ¸å¿ƒè§†å›¾ç®¡ç†å‡½æ•° ---
        /**
         * åˆ‡æ¢åˆ°æŒ‡å®šè§†å›¾ï¼Œå¹¶æ›´æ–°è§†å›¾å†å²ã€‚
         * @param {string} viewId - è¦æ˜¾ç¤ºçš„è§†å›¾çš„IDã€‚
         * @param {boolean} [pushToHistory=true] - æ˜¯å¦å°†å½“å‰è§†å›¾æ¨å…¥å†å²æ ˆã€‚
         */
        function showView(viewId, pushToHistory = true) {
            console.log(`[showView] Attempting to show view: ${viewId}. Current appState.currentView: ${appState.currentView}`);
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });

            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            document.getElementById(viewId).classList.remove('hidden');

            // æ›´æ–°å†å²è®°å½•
            if (pushToHistory && appState.currentView !== viewId) { // é¿å…é‡å¤æ·»åŠ å½“å‰è§†å›¾
                appState.viewHistory.push(appState.currentView);
                console.log(`[showView] Added ${appState.currentView} to history. History:`, appState.viewHistory);
            }
            appState.currentView = viewId;

            // æ ¹æ®è§†å›¾æ¸²æŸ“å†…å®¹
            renderViewContent(viewId);
            console.log(`[showView] Finished showing view: ${viewId}`);
        }

        /**
         * æ¸²æŸ“ç‰¹å®šè§†å›¾çš„å†…å®¹ã€‚
         * @param {string} viewId - å½“å‰è§†å›¾çš„IDã€‚
         */
        function renderViewContent(viewId) {
            console.log(`[renderViewContent] Rendering content for view: ${viewId}`);
            // æ¸…é™¤ selectionContent çš„ç±»ï¼Œæ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°è®¾ç½®
            selectionContent.classList.remove('grid-col-1-md-2', 'grid-col-2-md-3', 'grid-col-3-md-5');

            switch (viewId) {
                case 'welcome-view':
                    appState.viewHistory = [];
                    resetTestState();
                    console.log('[renderViewContent] Resetting appState and history.');
                    break;
                case 'confirm-role-view':
                    confirmedRoleSpan.textContent = appState.userRole === 'vip' ? 'VIP å­¦ç”Ÿ' : 'ç­è¯¾å­¦ç”Ÿ';
                    console.log(`[renderViewContent] Confirmed role: ${appState.userRole}`);
                    break;
                case 'selection-view':
                    if (appState.selectedUnit || appState.selectedContentType === 'past') {
                        console.log('[renderViewContent] Selection view: Rendering content type selection (from unit/past).');
                        renderContentTypeSelection(appState.selectedCategory, appState.selectedLevel);
                        if (appState.selectedContentType === 'unit') {
                            console.log('[renderViewContent] Selection view: Rendering unit selection.');
                            renderUnitSelection(appState.selectedCategory, appState.selectedLevel);
                        }
                    } else if (appState.selectedLevel) {
                        console.log('[renderViewContent] Selection view: Rendering level selection.');
                        renderLevelSelection(appState.selectedCategory);
                    } else if (appState.selectedCategory) {
                        console.log('[renderViewContent] Selection view: Rendering category selection (from level).');
                        renderCategorySelection();
                    } else {
                        console.log('[renderViewContent] Selection view: Initial render, rendering category selection.');
                        renderCategorySelection();
                    }
                    break;
                case 'info-view':
                    studentNameInput.value = '';
                    if (appState.userRole === 'class') {
                        studentClassInput.classList.remove('hidden');
                        studentClassInput.value = '';
                    } else {
                        studentClassInput.classList.add('hidden');
                        studentClassInput.value = '';
                    }
                    studentNameInput.focus();
                    console.log('[renderViewContent] Info view: Ready for student info.');
                    break;
                case 'test-view':
                    console.log('[renderViewContent] Test view: Initializing test logic.');
                    initializeTestLogic();
                    break;
                case 'results-view':
                    console.log('[renderViewContent] Results view: Rendering final results.');
                    renderFinalResults();
                    break;
            }
        }

        /**
         * è¿”å›ä¸Šä¸€ä¸ªè§†å›¾ã€‚
         */
        function goBack() {
            console.log(`[goBack] Current view: ${appState.currentView}, History:`, appState.viewHistory);
            if (appState.viewHistory.length > 0) {
                const prevViewId = appState.viewHistory.pop();
                console.log(`[goBack] Popped ${prevViewId} from history.`);

                // æ ¹æ®å½“å‰è§†å›¾ï¼Œé‡ç½®ç›¸å…³çŠ¶æ€
                if (appState.currentView === 'selection-view') {
                    // When going back from a deeper selection level, clear the deeper state
                    if (appState.selectedUnit || appState.selectedContentType === 'past') {
                         appState.selectedUnit = '';
                         appState.selectedContentType = '';
                         console.log('[goBack] Resetting selectedUnit and selectedContentType.');
                    } else if (appState.selectedLevel) {
                        appState.selectedLevel = '';
                        console.log('[goBack] Resetting selectedLevel.');
                    } else if (appState.selectedCategory) {
                        appState.selectedCategory = '';
                        console.log('[goBack] Resetting selectedCategory.');
                    }
                } else if (appState.currentView === 'info-view') {
                    appState.studentName = '';
                    appState.studentClass = '';
                    console.log('[goBack] Resetting student info.');
                } else if (appState.currentView === 'confirm-role-view') {
                    appState.userRole = '';
                    console.log('[goBack] Resetting user role.');
                } else if (appState.currentView === 'test-view') {
                    resetTestState();
                    console.log('[goBack] Resetting test state from test view.');
                } else if (appState.currentView === 'results-view') {
                    resetTestState();
                    console.log('[goBack] Resetting test state from results view.');
                }

                showView(prevViewId, false); // ä¸æ¨å…¥å†å²ï¼Œå› ä¸ºå®ƒå·²ç»è¢«å¼¹å‡ºäº†
                console.log(`[goBack] Navigated to previous view: ${prevViewId}`);
            } else {
                console.log('[goBack] History is empty, cannot go back.');
            }
        }


        // --- æ¸²æŸ“è¯åº“é€‰æ‹©è§†å›¾çš„ä¸åŒé˜¶æ®µ ---
        /**
         * æ¸²æŸ“ä¸€çº§åˆ†ç±»ï¼ˆReading, Listening, Speaking, Writingï¼‰ã€‚
         */
        function renderCategorySelection() {
            console.log('[renderCategorySelection] Starting to render category selection buttons.');
            selectionTitle.textContent = 'è¯·é€‰æ‹©åˆ†ç±»';
            selectionContent.innerHTML = ''; // Clear previous content
            selectionContent.classList.add('grid-col-1-md-2');

            const categories = Object.keys(vocabStructure);
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('btn-selection-item'); // Apply base styles
                if (appState.selectedCategory === category) {
                    button.classList.add('btn-selection-item-selected'); // Mark as selected
                }
                button.textContent = categoryNames[category] + ' ( ' + capitalizeFirstLetter(category) + ' )';
                button.dataset.category = category;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Category button "${category}" clicked! Event target:`, event.target);
                    appState.selectedCategory = category;
                    appState.selectedLevel = '';
                    appState.selectedContentType = '';
                    appState.selectedUnit = '';
                    showView('selection-view'); // Re-render selection-view to next level
                });
                selectionContent.appendChild(button);
                console.log(`[renderCategorySelection] Appended button for ${category}.`);
            });
            console.log('[renderCategorySelection] Finished rendering category selection buttons.');
        }

        /**
         * æ¸²æŸ“äºŒçº§åˆ†ç±»ï¼ˆåˆçº§ã€ä¸­çº§ã€é«˜çº§ï¼‰ã€‚
         * @param {string} category - å·²é€‰æ‹©çš„ä¸€çº§åˆ†ç±»ã€‚
         */
        function renderLevelSelection(category) {
            console.log(`[renderLevelSelection] Starting to render level selection buttons for category: ${category}.`);
            selectionTitle.textContent = `é€‰æ‹© ${categoryNames[category]} éš¾åº¦`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-2-md-3');

            const levels = Object.keys(vocabStructure[category]);
            
            levels.forEach(level => {
                const button = document.createElement('button');
                button.classList.add('btn-selection-item');
                if (appState.selectedLevel === level) {
                    button.classList.add('btn-selection-item-selected');
                }
                button.textContent = levelNames[level] + ' ( ' + capitalizeFirstLetter(level) + ' )';
                button.dataset.level = level;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Level button "${level}" clicked! Event target:`, event.target);
                    appState.selectedLevel = level;
                    appState.selectedContentType = '';
                    appState.selectedUnit = '';
                    showView('selection-view'); // Re-render selection-view to next level
                });
                selectionContent.appendChild(button);
                console.log(`[renderLevelSelection] Appended button for level ${level}.`);
            });
            console.log('[renderLevelSelection] Finished rendering level selection buttons.');
        }

        /**
         * æ¸²æŸ“ä¸‰çº§åˆ†ç±»ï¼ˆæŒ‰ç…§æˆè¯¾å•å…ƒã€æŒ‰ç…§å¾€æœŸå†…å®¹ï¼‰ã€‚
         * @param {string} category - å·²é€‰æ‹©çš„ä¸€çº§åˆ†ç±»ã€‚
         * @param {string} level - å·²é€‰æ‹©çš„äºŒçº§åˆ†ç±»ã€‚
         */
        function renderContentTypeSelection(category, level) {
            console.log(`[renderContentTypeSelection] Starting to render content type selection buttons for ${category}-${level}.`);
            selectionTitle.textContent = `é€‰æ‹© ${categoryNames[category]} ${levelNames[level]} å†…å®¹ç±»å‹`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-1-md-2');

            const availableTypes = Object.keys(vocabStructure[category][level]);

            const contentTypes = ['unit', 'past'];
            const contentNames = {
                unit: 'æŒ‰ç…§æˆè¯¾å•å…ƒ',
                past: 'æŒ‰ç…§å¾€æœŸå†…å®¹'
            };

            contentTypes.forEach(type => {
                if (availableTypes.includes(type)) {
                    const button = document.createElement('button');
                    button.classList.add('btn-selection-item');
                    if (appState.selectedContentType === type) {
                        button.classList.add('btn-selection-item-selected');
                    }
                    button.textContent = contentNames[type];
                    button.dataset.contentType = type;
                    button.addEventListener('click', (event) => {
                        console.log(`[Click] Content type button "${type}" clicked! Event target:`, event.target);
                        appState.selectedContentType = type;
                        appState.selectedUnit = '';
                        if (type === 'unit') {
                            showView('selection-view'); // Re-render selection-view to next level (unit selection)
                        } else { // 'past'
                            handleFinalSelection(); // Load vocabulary and proceed to info page
                        }
                    });
                    selectionContent.appendChild(button);
                    console.log(`[renderContentTypeSelection] Appended button for content type ${type}.`);
                }
            });
            console.log('[renderContentTypeSelection] Finished rendering content type selection buttons.');
        }

        /**
         * æ¸²æŸ“æˆè¯¾å•å…ƒé€‰æ‹©ï¼ˆæ ¹æ® vocabStructure å®é™…é…ç½®çš„å•å…ƒï¼‰ã€‚
         * @param {string} category - å·²é€‰æ‹©çš„ä¸€çº§åˆ†ç±»ã€‚
         * @param {string} level - å·²é€‰æ‹©çš„äºŒçº§åˆ†ç±»ã€‚
         */
        function renderUnitSelection(category, level) {
            console.log(`[renderUnitSelection] Starting to render unit selection buttons for ${category}-${level}.`);
            selectionTitle.textContent = `é€‰æ‹© ${categoryNames[category]} ${levelNames[level]} æˆè¯¾å•å…ƒ`;
            selectionContent.innerHTML = '';
            selectionContent.classList.add('grid-col-3-md-5');

            const unitsAvailable = vocabStructure[category]?.[level]?.unit;
            if (!unitsAvailable || unitsAvailable.length === 0) {
                selectionContent.innerHTML = '<p class="text-gray-600">å½“å‰éš¾åº¦æš‚æ— å•å…ƒè¯åº“ã€‚</p>';
                console.log('[renderUnitSelection] No units available for this selection.');
                return;
            }

            unitsAvailable.forEach(unitFileName => {
                const unitNumberMatch = unitFileName.match(/unit(\d+)\.json/);
                const unitNumber = unitNumberMatch ? unitNumberMatch[1] : unitFileName;

                const button = document.createElement('button');
                button.classList.add('btn-selection-item');
                 if (appState.selectedUnit === unitFileName) {
                    button.classList.add('btn-selection-item-selected');
                }
                button.textContent = `å•å…ƒ ${unitNumber}`;
                button.dataset.unit = unitFileName;
                button.addEventListener('click', (event) => {
                    console.log(`[Click] Unit button "${unitFileName}" clicked! Event target:`, event.target);
                    appState.selectedUnit = unitFileName;
                    handleFinalSelection(); // Load vocabulary and proceed to info page
                });
                selectionContent.appendChild(button);
                console.log(`[renderUnitSelection] Appended button for unit ${unitNumber}.`);
            });
            console.log('[renderUnitSelection] Finished rendering unit selection buttons.');
        }

        /**
         * å¤„ç†æœ€ç»ˆé€‰æ‹©å¹¶åŠ è½½è¯æ±‡æ•°æ®ã€‚
         */
        async function handleFinalSelection() {
            console.log('[handleFinalSelection] Starting vocabulary loading...');
            let jsonFileName = '';
            if (appState.selectedContentType === 'unit') {
                jsonFileName = appState.selectedUnit;
            } else { // 'past'
                jsonFileName = vocabStructure[appState.selectedCategory][appState.selectedLevel].past;
            }
            const jsonPath = `data/${jsonFileName}`;
            console.log(`[handleFinalSelection] Attempting to load JSON from: ${jsonPath}`);

            selectionContent.innerHTML = '<p class="text-xl text-gray-600 animate-pulse">åŠ è½½è¯æ±‡ä¸­ï¼Œè¯·ç¨å€™...</p>';
            selectionContent.classList.remove('grid-col-1-md-2', 'grid-col-2-md-3', 'grid-col-3-md-5');
            selectionContent.classList.add('flex', 'justify-center', 'items-center', 'py-10');


            try {
                const response = await fetch(jsonPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${jsonPath}`);
                }
                appState.currentTestVocabulary = await response.json();

                if (!appState.currentTestVocabulary || appState.currentTestVocabulary.length === 0) {
                    console.warn('[handleFinalSelection] Loaded vocabulary is empty.');
                    alert('æ‰€é€‰è¯åº“ä¸ºç©ºï¼Œè¯·é€‰æ‹©å…¶ä»–è¯åº“æˆ–è”ç³»è€å¸ˆæ·»åŠ è¯æ±‡ã€‚');
                    goBack();
                    return;
                }

                console.log('[handleFinalSelection] Loaded vocabulary for test:', appState.currentTestVocabulary);
                showView('info-view'); // Proceed to student info view

            } catch (error) {
                console.error('[handleFinalSelection] Vocabulary loading error:', error);
                alert(`åŠ è½½è¯åº“å¤±è´¥: ${error.message}ã€‚è¯·æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®: ${jsonPath}ã€‚`);
                goBack();
            }
        }

        /**
         * é‡ç½®æ‰€æœ‰æµ‹è¯•ç›¸å…³çš„çŠ¶æ€æ•°æ®ã€‚
         */
        function resetTestState() {
            console.log('[resetTestState] Resetting all test-related state.');
            appState.currentTestVocabulary = [];
            appState.shuffledTestVocabulary = [];
            appState.currentWordIndex = 0;
            appState.correctAnswersCount = 0;
            appState.questionsAttempted = 0;
            appState.incorrectAnswers = [];
            appState.testStartTime = null;
        }

        // --- å¬å†™æµ‹è¯•æ ¸å¿ƒé€»è¾‘ (ä»æ—§ç‰ˆæœ¬å¤åˆ¶å¹¶é›†æˆ) ---
        function initializeTestLogic() {
            console.log('[initializeTestLogic] Initializing test logic...');
            appState.shuffledTestVocabulary = shuffleArray([...appState.currentTestVocabulary]);
            appState.currentWordIndex = 0;
            appState.correctAnswersCount = 0;
            appState.questionsAttempted = 0;
            appState.incorrectAnswers = [];
            appState.testStartTime = new Date();

            // ç¡®ä¿æµ‹è¯•è§†å›¾UIå…ƒç´ å¯è§æ€§æ­£ç¡®
            answerInput.classList.remove('hidden');
            getExampleBtn.classList.remove('hidden');
            checkAnswerBtn.classList.remove('hidden');
            nextWordBtn.classList.add('hidden');
            endTestBtn.classList.remove('hidden');
            feedbackMessage.classList.remove('hidden');
            exampleSentenceDisplay.classList.remove('hidden');

            loadQuestion();
            console.log('[initializeTestLogic] Test initialized and first question loaded.');
        }

        function loadQuestion() {
            console.log(`[loadQuestion] Loading question ${appState.currentWordIndex + 1}...`);
            if (appState.currentWordIndex >= appState.shuffledTestVocabulary.length) {
                appState.shuffledTestVocabulary = shuffleArray([...appState.currentTestVocabulary]);
                appState.currentWordIndex = 0;
                console.log('[loadQuestion] Reached end of vocabulary, reshuffling and restarting.');
            }

            const currentPair = appState.shuffledTestVocabulary[appState.currentWordIndex];
            questionDisplay.textContent = currentPair.chinese;
            answerInput.value = '';
            answerInput.classList.remove('feedback-correct', 'feedback-incorrect');
            answerInput.readOnly = false;
            answerInput.focus();
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600');
            nextWordBtn.classList.add('hidden');
            checkAnswerBtn.classList.remove('hidden');
            exampleSentenceDisplay.textContent = 'ç‚¹å‡» "è·å–ä¾‹å¥" æŸ¥çœ‹ä¸Šä¸‹æ–‡';
            getExampleBtn.disabled = false;
            console.log(`[loadQuestion] Displaying Chinese: "${currentPair.chinese}"`);
        }

        function checkCurrentAnswer() {
            console.log('[checkCurrentAnswer] Checking answer...');
            appState.questionsAttempted++;
            const typedAnswer = answerInput.value.trim();
            const correctEnglish = appState.shuffledTestVocabulary[appState.currentWordIndex].english.trim();

            answerInput.readOnly = true;
            getExampleBtn.disabled = true;

            if (typedAnswer.toLowerCase() === correctEnglish.toLowerCase()) {
                feedbackMessage.textContent = 'æ­£ç¡®ï¼ğŸ‘';
                feedbackMessage.classList.remove('text-red-600');
                feedbackMessage.classList.add('text-green-600');
                answerInput.classList.add('feedback-correct');
                appState.correctAnswersCount++;
                playPronunciation(correctEnglish);
                console.log('[checkCurrentAnswer] Answer correct.');
            } else {
                feedbackMessage.innerHTML = `é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: "${correctEnglish}"`;
                feedbackMessage.appendChild(createPlayButton(correctEnglish));
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-600');
                answerInput.classList.add('feedback-incorrect');
                appState.incorrectAnswers.push({
                    chinese: appState.shuffledTestVocabulary[appState.currentWordIndex].chinese,
                    typed: typedAnswer,
                    correct: correctEnglish
                });
                console.log(`[checkCurrentAnswer] Answer incorrect. Correct: "${correctEnglish}", Typed: "${typedAnswer}"`);
            }

            checkAnswerBtn.classList.add('hidden');
            nextWordBtn.classList.remove('hidden');
            console.log('[checkCurrentAnswer] Answer checked. Ready for next word.');
        }

        function nextWord() {
            console.log('[nextWord] Moving to next word...');
            appState.currentWordIndex++;
            loadQuestion();
        }

        function endTestSession() {
            console.log('[endTestSession] Ending test session.');
            showView('results-view');
        }

        function renderFinalResults() {
            console.log('[renderFinalResults] Rendering final results...');
            // éšè—æµ‹è¯•è§†å›¾ä¸­çš„æ‰€æœ‰å¯äº¤äº’å…ƒç´ 
            answerInput.classList.add('hidden');
            getExampleBtn.classList.add('hidden');
            checkAnswerBtn.classList.add('hidden');
            nextWordBtn.classList.add('hidden');
            endTestBtn.classList.add('hidden');
            feedbackMessage.classList.add('hidden');
            exampleSentenceDisplay.classList.add('hidden');


            // å¡«å……ç»“æœæ€»ç»“
            summaryName.textContent = appState.studentName || 'æœªå¡«å†™';
            if (appState.userRole === 'class') {
                summaryClassRow.classList.remove('hidden');
                summaryClass.textContent = appState.studentClass || 'æœªå¡«å†™';
            } else {
                summaryClassRow.classList.add('hidden');
            }
            summaryDate.textContent = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let accuracy = 0;
            if (appState.questionsAttempted > 0) {
                accuracy = (appState.correctAnswersCount / appState.questionsAttempted) * 100;
            }
            summaryAccuracy.textContent = `${accuracy.toFixed(2)}% (${appState.correctAnswersCount} / ${appState.questionsAttempted})`;
            
            incorrectCountSpan.textContent = appState.incorrectAnswers.length;

            // å¡«å……ç­”é”™é¢˜ç›®åˆ—è¡¨
            resultsList.innerHTML = '';
            if (appState.incorrectAnswers.length === 0) {
                resultsList.innerHTML = '<p class="text-green-700 font-semibold">å¤ªæ£’äº†ï¼æ‰€æœ‰é¢˜ç›®éƒ½æ­£ç¡®ï¼</p>';
                console.log('[renderFinalResults] All answers correct!');
            } else {
                appState.incorrectAnswers.forEach(item => {
                    const li = document.createElement('li');
                    li.classList.add('mb-2', 'pb-2', 'border-b', 'border-gray-200', 'flex', 'flex-col');
                    li.innerHTML = `
                        <p><strong>ä¸­æ–‡:</strong> ${item.chinese}</p>
                        <p class="flex items-center"><strong>æ‚¨è¾“å…¥:</strong> <span class="text-red-600">${item.typed || '[æœªè¾“å…¥]'}</span></p>
                        <p class="flex items-center"><strong>æ­£ç¡®ç­”æ¡ˆ:</strong> <span class="text-green-600">${item.correct}</span></p>
                    `;
                    const correctSpan = li.querySelector('.text-green-600');
                    if (correctSpan) {
                        correctSpan.parentNode.appendChild(createPlayButton(item.correct));
                    }
                    resultsList.appendChild(li);
                });
                console.log(`[renderFinalResults] Displaying ${appState.incorrectAnswers.length} incorrect answers.`);
            }
            console.log('[renderFinalResults] Results rendering complete.');
        }

        // --- è¯­éŸ³åˆæˆå’ŒLLMä¾‹å¥åŠŸèƒ½ ---

        /**
         * Plays the pronunciation of a given word.
         * @param {string} word - The word to pronounce.
         */
        function playPronunciation(word) {
            console.log(`[playPronunciation] Attempting to play: "${word}"`);
            if (!speechSynth || !voicesLoaded) {
                console.warn('SpeechSynthesis API not ready or supported in this browser. Pronunciation will not work.');
                return;
            }
            if (speechSynth.speaking) {
                speechSynth.cancel();
                console.log('[playPronunciation] Cancelling previous speech.');
            }
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            utterance.volume = 1;
            utterance.rate = 1;
            utterance.pitch = 1;
            speechSynth.speak(utterance);
            console.log(`[playPronunciation] Spoke: "${word}"`);
        }

        /**
         * Creates and returns a play button element.
         * @param {string} wordToSpeak - The word to be spoken when the button is clicked.
         * @returns {HTMLButtonElement} The play button element.
         */
        function createPlayButton(wordToSpeak) {
            const button = document.createElement('button');
            button.classList.add('play-button');
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            button.title = `æ’­æ”¾ "${wordToSpeak}" çš„å‘éŸ³`;
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                playPronunciation(wordToSpeak);
            });
            return button;
        }

        /**
         * Generates an example sentence using the Gemini API (gemini-2.0-flash).
         */
        async function getExampleSentence() {
            console.log('[getExampleSentence] Attempting to get example sentence...');
            const currentPair = appState.shuffledTestVocabulary[appState.currentWordIndex];
            const englishWord = currentPair.english;

            const isAnswerEmpty = answerInput.value.trim() === '';
            const isAnswerChecked = answerInput.readOnly;
            const isAnswerCorrect = answerInput.classList.contains('feedback-correct');

            if (isAnswerEmpty && !isAnswerChecked) {
                exampleSentenceDisplay.textContent = 'è¯·è¾“å…¥è‹±æ–‡è¯æ±‡æˆ–çŸ­è¯­åå†è·å–ä¾‹å¥ã€‚';
                console.warn('[getExampleSentence] Answer input is empty, cannot get example.');
                return;
            } else if (isAnswerChecked && !isAnswerCorrect) {
                 exampleSentenceDisplay.textContent = 'è¯·æ£€æŸ¥æ‚¨çš„ç­”æ¡ˆï¼ˆçº¢è‰²éƒ¨åˆ†ï¼‰ï¼Œå¹¶æŸ¥çœ‹æ­£ç¡®ç­”æ¡ˆï¼Œå†è·å–ä¾‹å¥ã€‚';
                 console.warn('[getExampleSentence] Answer incorrect and checked, guiding user to correct first.');
                 return;
            }

            exampleSentenceDisplay.innerHTML = '<div class="loading-spinner"></div>';
            getExampleBtn.disabled = true;
            console.log(`[getExampleSentence] Prompting LLM for example of: "${englishWord}"`);

            try {
                const prompt = `è¯·æä¾›ä¸€ä¸ªå…³äºè‹±æ–‡è¯æ±‡æˆ–çŸ­è¯­ "${englishWord}" çš„ä¾‹å¥ã€‚ä¾‹å¥éœ€é€‚åˆä¸­çº§è‹±è¯­å­¦ä¹ è€…ï¼Œä¸”å¥å­å†…å®¹é¿å…è¿‡äºç®€å•æˆ–è¿‡äºå¤æ‚ã€‚`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    exampleSentenceDisplay.textContent = `ä¾‹å¥: "${text}"`;
                    console.log(`[getExampleSentence] LLM example received: "${text}"`);
                } else {
                    exampleSentenceDisplay.textContent = 'æ— æ³•ç”Ÿæˆä¾‹å¥ã€‚è¯·ç¨åå†è¯•ã€‚';
                    console.error('[getExampleSentence] LLM response structure unexpected:', result);
                }
            } catch (error) {
                exampleSentenceDisplay.textContent = 'è·å–ä¾‹å¥å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚';
                console.error('[getExampleSentence] Error calling LLM API:', error);
            } finally {
                if (!answerInput.readOnly) {
                    getExampleBtn.disabled = false;
                }
                console.log('[getExampleSentence] Example sentence request finished.');
            }
        }


        // --- è¾…åŠ©æ˜ å°„å¯¹è±¡ï¼ˆæ–¹ä¾¿æ˜¾ç¤ºï¼‰ ---
        const categoryNames = {
            reading: 'é˜…è¯»', listening: 'å¬åŠ›', speaking: 'å£è¯­', writing: 'å†™ä½œ'
        };
        const levelNames = {
            beginner: 'åˆçº§', intermediate: 'ä¸­çº§', advanced: 'é«˜çº§'
        };
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // --- è¯­éŸ³åˆæˆåˆå§‹åŒ– ---
        if (speechSynth) {
            speechSynth.onvoiceschanged = () => {
                voicesLoaded = true;
                console.log('[SpeechSynthesis] Voices loaded.');
            };
            if (speechSynth.getVoices().length > 0) {
                voicesLoaded = true;
                console.log('[SpeechSynthesis] Voices already available.');
            }
        } else {
            console.warn('[SpeechSynthesis] æµè§ˆå™¨ä¸æ”¯æŒ SpeechSynthesis APIã€‚å‘éŸ³åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚');
        }

        /**
         * Utility function to shuffle an array.
         * @param {Array} array
         * @returns {Array}
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        vipStudentBtn.addEventListener('click', () => {
            console.log('[Event] VIP Student button clicked.');
            appState.userRole = 'vip';
            showView('confirm-role-view');
        });

        classStudentBtn.addEventListener('click', () => {
            console.log('[Event] Class Student button clicked.');
            appState.userRole = 'class';
            showView('confirm-role-view');
        });

        confirmBackBtn.addEventListener('click', goBack);

        confirmRoleContinueBtn.addEventListener('click', () => {
            console.log('[Event] Confirm Role Continue button clicked.');
            appState.viewHistory = []; // From confirm-role-view, always start a fresh history for selection
            showView('selection-view');
        });

        selectionBackBtn.addEventListener('click', goBack);

        // å­¦ç”Ÿä¿¡æ¯å¡«å†™é¡µé¢çš„å¼€å§‹æµ‹è¯•æŒ‰é’®
        startTestBtn.addEventListener('click', () => {
            console.log('[Event] Start Test button clicked.');
            appState.studentName = studentNameInput.value.trim();
            if (appState.userRole === 'class') {
                appState.studentClass = studentClassInput.value.trim();
            } else {
                appState.studentClass = ''; // VIP students don't have a class
            }

            if (!appState.studentName) {
                alert('è¯·è¾“å…¥æ‚¨çš„å§“åæ‰èƒ½å¼€å§‹æµ‹è¯•ï¼');
                console.warn('[Event] Student name not entered.');
                return;
            }
            showView('test-view'); // è·³è½¬åˆ°æµ‹è¯•è§†å›¾
        });
        infoBackBtn.addEventListener('click', goBack);

        // å¬å†™æµ‹è¯•è§†å›¾çš„æŒ‰é’®
        checkAnswerBtn.addEventListener('click', checkCurrentAnswer);
        nextWordBtn.addEventListener('click', nextWord);
        endTestBtn.addEventListener('click', endTestSession); // è°ƒç”¨ç»“æŸæµ‹è¯•ä¼šè¯çš„å‡½æ•°
        getExampleBtn.addEventListener('click', getExampleSentence);
        testBackBtn.addEventListener('click', goBack); // æµ‹è¯•è§†å›¾çš„è¿”å›æŒ‰é’®

        // ç»“æœè§†å›¾çš„é‡æ–°å¼€å§‹æŒ‰é’®
        resultsRestartBtn.addEventListener('click', () => {
            console.log('[Event] Restart Test button clicked.');
            // æ¸…é™¤æ‰€æœ‰é€‰æ‹©ï¼Œå›åˆ°æ¬¢è¿ç•Œé¢ï¼Œé‡æ–°å¼€å§‹æ•´ä¸ªæµç¨‹
            appState.userRole = '';
            appState.selectedCategory = '';
            appState.selectedLevel = '';
            appState.selectedContentType = '';
            appState.selectedUnit = '';
            appState.studentName = '';
            appState.studentClass = '';
            resetTestState(); // å½»åº•é‡ç½®æµ‹è¯•ç›¸å…³çŠ¶æ€
            showView('welcome-view');
        });
        resultsBackBtn.addEventListener('click', goBack); // ç»“æœè§†å›¾çš„è¿”å›æŒ‰é’®


        // å…è®¸æŒ‰ Enter é”®è§¦å‘æ£€æŸ¥ç­”æ¡ˆæˆ–ä¸‹ä¸€ä¸ª
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                console.log('[Event] Enter key pressed on answer input.');
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkCurrentAnswer();
                } else if (!nextWordBtn.classList.contains('hidden')) {
                    nextWord();
                }
            }
        });


        // --- å¯åŠ¨åº”ç”¨ ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[App Startup] DOMContentLoaded fired. Initializing view.');
            showView('welcome-view', false); // é»˜è®¤æ˜¾ç¤ºæ¬¢è¿è§†å›¾ï¼Œä¸æ¨å…¥å†å²
        });
    </script>
</body>
</html>
